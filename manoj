<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGST Office Welfare Society - Monthly Tracking System v3.8 (Enhanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- For PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - Replace these values with your Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyB20eIg6jmhObzYr59_RthaedB5xgM4Zdw",
            authDomain: "welfare-society-ce5cc.firebaseapp.com",
            projectId: "welfare-society-ce5cc",
            storageBucket: "welfare-society-ce5cc.firebasestorage.app",
            messagingSenderId: "374272271451",
            appId: "1:374272271451:web:c1741c463d0b94306f0b7e",
            measurementId: "G-NBJ6NYZMPR"
        };

        // Initialize Firebase
        let app = null;
        let db = null;
        let firebaseEnabled = false;

        try {
            // Check if Firebase config has been set up
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                firebaseEnabled = true;
                console.log('Firebase initialized successfully');
            } else {
                console.log('Firebase not configured - using localStorage only. Set up Firebase config to enable cloud sync.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Make Firebase functions available globally
        window.firebaseDB = db;
        window.firebaseEnabled = firebaseEnabled;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseDoc = doc;
        window.firebaseOnSnapshot = onSnapshot;

        // Sync data to Firebase
        window.syncToFirebase = async function(dataKey, data) {
            if (!firebaseEnabled || !db) {
                return false;
            }

            try {
                const docRef = doc(db, 'welfare_data', dataKey);
                await setDoc(docRef, {
                    ...data,
                    lastSynced: new Date().toISOString()
                });
                console.log('Data synced to Firebase');
                return true;
            } catch (error) {
                console.error('Error syncing to Firebase:', error);
                return false;
            }
        };

        // Load data from Firebase
        window.loadFromFirebase = async function(dataKey) {
            if (!firebaseEnabled || !db) {
                return null;
            }

            try {
                const docRef = doc(db, 'welfare_data', dataKey);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log('Data loaded from Firebase');
                    return docSnap.data();
                }
                return null;
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                return null;
            }
        };

        // Setup real-time listener for data changes
        window.setupFirebaseListener = function(dataKey, callback) {
            if (!firebaseEnabled || !db) {
                return null;
            }

            try {
                const docRef = doc(db, 'welfare_data', dataKey);
                return onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        callback(doc.data());
                    }
                });
            } catch (error) {
                console.error('Error setting up Firebase listener:', error);
                return null;
            }
        };
    </script>
    
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .retired-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #f39c12;
        }
        
        .retiring-soon-row {
            background-color: #ffeaa7 !important;
            border-left: 4px solid #e67e22;
        }
        
        .paid-row {
            background-color: #d5f4e6 !important;
            border-left: 4px solid #2ecc71;
        }
        
        .pending-row {
            background-color: #fadbd8 !important;
            border-left: 4px solid #e74c3c;
        }
        
        .advance-row {
            background-color: #d6eaf8 !important;
            border-left: 4px solid #3498db;
        }
        
        .deleted-row {
            background-color: #f5f5f5 !important;
            border-left: 4px solid #95a5a6;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .parked-row {
            background-color: #e0e0e0 !important;
            border-left: 4px solid #9e9e9e;
            opacity: 0.8;
        }
        
        .partial-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-active { background: #d4edda; color: #155724; }
        .status-retired { background: #f8d7da; color: #721c24; }
        .status-retiring { background: #fff3cd; color: #856404; }
        .status-pending { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-advance { background: #cce5ff; color: #004085; }
        .status-deleted { background: #e0e0e0; color: #666; }
        .status-parked { background: #e2e3e5; color: #383d41; }
        .status-transferred { background: #d1c4e9; color: #4a148c; }
        
        /* Hover Effects */
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
            }
            
            .print-table {
                border-collapse: collapse;
                width: 100%;
                font-size: 12px;
            }
            
            .print-table th, .print-table td {
                border: 1px solid #000;
                padding: 6px;
            }
            
            .print-table th {
                background-color: #f0f0f0 !important;
                color: #000 !important;
            }
            
            .receipt-print {
                border: 2px solid #000 !important;
                padding: 20px !important;
                margin: 20px !important;
            }
        }
        
        /* Payment Button Animation */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Tab Styles */
        .tab-btn {
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        
        /* Inline Edit Styles */
        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .editable-cell:hover {
            background-color: #fef3c7;
        }
        
        /* Animation for save */
        @keyframes highlightSave {
            0% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
        
        .save-highlight {
            animation: highlightSave 1s ease-in-out;
        }
        
        /* Undo Toast */
        .undo-toast {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 300px;
        }
        
        .sync-success {
            background: #10b981;
            color: white;
        }
        
        .sync-error {
            background: #ef4444;
            color: white;
        }
        
        .sync-warning {
            background: #f59e0b;
            color: white;
        }
        
        /* Shake animation for login error */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Receipt Styles */
        .receipt-container {
            border: 2px solid #000;
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            font-family: 'Courier New', monospace;
            position: relative;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 3px double #000;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .receipt-details {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .receipt-details td {
            padding: 8px;
            border: 1px solid #000;
        }
        
        .receipt-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed #000;
            text-align: center;
        }
        
        .watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 120px;
            transform: rotate(-45deg);
            z-index: -1;
            top: 30%;
            left: 10%;
            font-weight: bold;
        }
        
        /* WhatsApp Share Button Styling */
        .whatsapp-share-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
        }
        
        .whatsapp-share-btn:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
        }
        
        .download-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin: 10px 0;
        }
        
        .download-btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action buttons styling */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background-color: #3b82f6;
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #2563eb;
        }
        
        .park-btn {
            background-color: #6b7280;
            color: white;
        }
        
        .park-btn:hover {
            background-color: #4b5563;
        }
        
        .retire-btn {
            background-color: #f59e0b;
            color: white;
        }
        
        .retire-btn:hover {
            background-color: #d97706;
        }
        
        .delete-btn {
            background-color: #ef4444;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #dc2626;
        }
        
        .restore-btn {
            background-color: #10b981;
            color: white;
        }
        
        .restore-btn:hover {
            background-color: #059669;
        }
        
        .transfer-btn {
            background-color: #8e44ad;
            color: white;
        }
        
        .transfer-btn:hover {
            background-color: #7d3c98;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Excel export styling */
        .excel-export-btn {
            background: linear-gradient(135deg, #0d8b5c 0%, #0a6e48 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .excel-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 139, 92, 0.3);
        }

        /* Network Status Indicator */
        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .network-online {
            background: #10b981;
            color: white;
        }
        
        .network-offline {
            background: #ef4444;
            color: white;
        }

        /* Firestore Sync Button */
        .firebase-sync-btn {
            background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .firebase-sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 167, 38, 0.3);
        }

        /* Enhanced Receipt Styles */
        .receipt-amount {
            font-size: 28px;
            font-weight: bold;
            color: #155724;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-radius: 10px;
            border: 2px solid #28a745;
        }
        
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .receipt-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: left;
            padding: 10px;
            border: 1px solid #dee2e6;
        }
        
        .receipt-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
        }
        
        .receipt-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .amount-paid {
            color: #155724;
            font-weight: bold;
            font-size: 18px;
        }
        
        .amount-pending {
            color: #721c24;
            font-weight: bold;
            font-size: 18px;
        }
        
        .receipt-stamp {
            width: 150px;
            height: 100px;
            border: 2px dashed #dc3545;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #dc3545;
            transform: rotate(-15deg);
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.8);
        }
    </style>
    
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Network Status Indicator -->
    <div id="networkStatus" class="network-status hidden">
        <i class="fas fa-wifi"></i>
        <span id="networkStatusText">Online</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen"></div>

    <!-- Main App (Initially hidden) -->
    <div id="app" class="fade-in hidden">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-700 to-purple-800 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-building text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">DGST Welfare Society</h1>
                            <p class="text-blue-200 text-sm">Monthly Tracking System v3.8 - Enhanced Receipt System</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="hidden md:block text-right">
                            <p class="text-sm text-blue-200" id="currentDateTime"></p>
                            <p class="text-sm font-semibold" id="userRole">Administrator</p>
                            <div id="firebaseSyncStatus" class="flex items-center justify-end mt-1">
                                <i class="fas fa-cloud text-gray-400 mr-1"></i>
                                <span class="text-gray-300 text-xs">Checking...</span>
                            </div>
                        </div>
                        
                        <!-- Settings Dropdown Menu -->
                        <div class="relative">
                            <button 
                                id="userMenuBtn"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2"
                            >
                                <i class="fas fa-user-circle"></i>
                                <span id="userRoleText">Admin</span>
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg z-50 border border-gray-200">
                                <div class="p-4 border-b">
                                    <p class="font-semibold text-gray-800" id="dropdownUserName">Admin User</p>
                                    <p class="text-sm text-gray-600">DGST Welfare Society</p>
                                </div>
                                <div class="py-2">
                                    <button 
                                        onclick="showSettingsModal()"
                                        class="w-full text-left px-4 py-3 hover:bg-blue-50 text-gray-700 flex items-center gap-2"
                                        id="settingsBtn"
                                    >
                                        <i class="fas fa-cog text-gray-600"></i>
                                        Settings
                                    </button>
                                    <button 
                                        onclick="showWelfareSchemes()"
                                        class="w-full text-left px-4 py-3 hover:bg-green-50 text-green-600 flex items-center gap-2"
                                    >
                                        <i class="fas fa-hand-holding-heart text-green-600"></i>
                                        Welfare Schemes
                                    </button>
                                    <button 
                                        onclick="showChangePasswordModal()"
                                        class="w-full text-left px-4 py-3 hover:bg-purple-50 text-purple-600 flex items-center gap-2"
                                    >
                                        <i class="fas fa-key text-purple-600"></i>
                                        Change Passwords
                                    </button>
                                    <div class="border-t my-2"></div>
                                    <button 
                                        onclick="logout()"
                                        class="w-full text-left px-4 py-3 hover:bg-red-50 text-red-600 flex items-center gap-2"
                                    >
                                        <i class="fas fa-sign-out-alt"></i>
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Current Month Info -->
            <div class="glass-card rounded-2xl p-6 mb-8 bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-calendar-alt mr-3 text-blue-600"></i>
                            <span id="currentMonthYear">December 2025 - January 2026</span>
                        </h2>
                        <p class="text-gray-600 mt-1">Monthly Tracking System Active - 120 Members</p>
                        <div class="flex items-center gap-2 mt-2">
                            <div id="firebaseStatus" class="flex items-center gap-2">
                                <i class="fas fa-circle text-xs text-green-500"></i>
                                <span class="text-sm">System: <span id="firebaseStatusText">Ready</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <!-- Current Receivable -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-blue-700" id="currentMonthReceivable">₹24,000</div>
                            <div class="text-sm text-blue-600">Current Receivable</div>
                        </div>
                        
                        <!-- Current Month Received -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-green-700" id="currentMonthReceived">₹0</div>
                            <div class="text-sm text-green-600">Current Month Received</div>
                        </div>
                        
                        <!-- Current Month Withdrawn -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-red-700" id="currentMonthWithdrawn">₹0</div>
                            <div class="text-sm text-red-600">Current Month Withdrawn</div>
                        </div>
                        
                        <!-- Current Balance -->
                        <div class="text-center">
                            <div class="text-lg font-bold text-purple-700" id="currentBalance">₹0</div>
                            <div class="text-sm text-purple-600">Current Balance</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Total Members</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="totalMembers">120</p>
                        </div>
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button 
                            onclick="showAllMembersView()"
                            class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-2"
                        >
                            View All Members <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Current Receivable -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Current Receivable</p>
                            <p class="text-3xl font-bold text-blue-700 mt-2" id="totalReceivable">₹24,000</p>
                        </div>
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-gray-500">
                        <p>Total amount currently receivable from all members</p>
                    </div>
                </div>

                <!-- Current Month Received -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Current Month Received</p>
                            <p class="text-3xl font-bold text-purple-700 mt-2" id="totalReceived">₹0</p>
                        </div>
                        <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-hand-holding-usd text-purple-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="collectionProgress" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Pending Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold">Pending Payments</p>
                            <p class="text-3xl font-bold text-red-700 mt-2" id="pendingMembers">120</p>
                        </div>
                        <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-clock text-red-600 text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button 
                            onclick="showQuickPaymentModal()"
                            class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2 quick-payment-btn"
                        >
                            <i class="fas fa-plus-circle"></i> Quick Add Payment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Add Payment -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer pulse bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 quick-payment-btn" onclick="showQuickPaymentModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Add Payment</h3>
                            <p class="text-sm text-gray-600">Record member payment with receipt</p>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-green-600 font-semibold">
                        <i class="fas fa-bolt mr-1"></i> Click to add payment with receipt
                    </div>
                </div>

                <!-- Add Member -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer add-member-btn" onclick="showAddMemberModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-plus text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Add New Member</h3>
                            <p class="text-sm text-gray-600">Register new society member</p>
                        </div>
                    </div>
                </div>

                <!-- All Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showAllMembersView()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">All Members</h3>
                            <p class="text-sm text-gray-600">View complete member list with payments</p>
                        </div>
                    </div>
                </div>

                <!-- Welfare Schemes -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showWelfareSchemes()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-pink-500 to-rose-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-hand-holding-heart text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Welfare Schemes</h3>
                            <p class="text-sm text-gray-600">सदस्य कल्याण योजनाएं</p>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showMessagingPanel()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-green-600 to-teal-600 rounded-xl flex items-center justify-center">
                            <i class="fab fa-whatsapp text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">WhatsApp Messaging</h3>
                            <p class="text-sm text-gray-600">Send bulk messages/reminders</p>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer edit-members-btn" onclick="showEditMembersModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-edit text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Edit Members</h3>
                            <p class="text-sm text-gray-600">Edit member details and payments</p>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Reports -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showPaymentReports()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice-dollar text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Payment Reports</h3>
                            <p class="text-sm text-gray-600">View all payment history</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pending Members -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showPendingPayments()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Pending Payments</h3>
                            <p class="text-sm text-gray-600">View pending dues list</p>
                        </div>
                    </div>
                </div>

                <!-- Excel Data Export Button -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showExcelExportOptions()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-teal-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-excel text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Excel Data Export</h3>
                            <p class="text-sm text-gray-600">Export all data to Excel</p>
                        </div>
                    </div>
                </div>

                <!-- Parked Members View -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showParkedMembers()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-gray-500 to-gray-700 rounded-xl flex items-center justify-center">
                            <i class="fas fa-parking text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Parked Members</h3>
                            <p class="text-sm text-gray-600">Non-contributing members</p>
                        </div>
                    </div>
                </div>

                <!-- Retired Members Details -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showRetiredMembersDetails()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-amber-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-clock text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Retired Members</h3>
                            <p class="text-sm text-gray-600">Detailed retired members list</p>
                        </div>
                    </div>
                </div>

                <!-- JSON Export Button -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="exportDataForEmail()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-teal-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-export text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">डेटा बैकअप</h3>
                            <p class="text-sm text-gray-600">JSON फ़ाइल डाउनलोड करें</p>
                        </div>
                    </div>
                </div>

                <!-- Main Account Withdrawal Button -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer withdrawal-btn" onclick="showMainAccountWithdrawalModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-university text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Main Account Withdrawal</h3>
                            <p class="text-sm text-gray-600">Society account से निकासी</p>
                        </div>
                    </div>
                </div>

                <!-- Withdrawal Reports -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showWithdrawalReports()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-pink-500 to-rose-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-file-invoice text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Withdrawal Reports</h3>
                            <p class="text-sm text-gray-600">View all withdrawals</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Reset Data Button -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer reset-btn" onclick="showResetDataModal()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-redo text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Reset Data</h3>
                            <p class="text-sm text-gray-600">Secure reset with backup & restore</p>
                        </div>
                    </div>
                </div>
                
                <!-- Transfer Members View -->
                <div class="glass-card rounded-2xl p-6 hover-lift cursor-pointer" onclick="showTransferredMembers()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Transferred Members</h3>
                            <p class="text-sm text-gray-600">स्थानांतरित सदस्य</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Payments -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-xl">
                        <i class="fas fa-history mr-3"></i>Recent Payments
                    </h3>
                    <button 
                        onclick="showPaymentReports()"
                        class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-2"
                    >
                        View All <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="space-y-3 max-h-60 overflow-y-auto" id="recentPayments">
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-circle-notch fa-spin text-xl"></i>
                        <p class="mt-2">Loading payment history...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Withdrawals -->
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-800 text-xl">
                        <i class="fas fa-money-check-alt mr-3"></i>Recent Withdrawals
                    </h3>
                    <button 
                        onclick="showWithdrawalReports()"
                        class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2"
                    >
                        View All <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="space-y-3 max-h-60 overflow-y-auto" id="recentWithdrawals">
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-circle-notch fa-spin text-xl"></i>
                        <p class="mt-2">Loading withdrawal history...</p>
                    </div>
                </div>
            </div>

            <!-- Member Categories -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Designation Breakdown -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="font-bold text-gray-800 text-xl mb-6">
                        <i class="fas fa-briefcase mr-3"></i>Designation Breakdown
                    </h3>
                    
                    <div class="space-y-4 max-h-80 overflow-y-auto">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-tie text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-blue-800">Assistant</p>
                                    <p class="text-xs text-blue-600">Multiple departments</p>
                                </div>
                            </div>
                            <span class="font-bold text-2xl text-blue-600" id="assistantCount">0</span>
                        </div>

                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-file-invoice-dollar text-green-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-green-800">Accountant/Auditor</p>
                                    <p class="text-xs text-green-600">Finance department</p>
                                </div>
                            </div>
                            <span class="font-bold text-2xl text-green-600" id="accountantCount">0</span>
                        </div>

                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-cog text-purple-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-purple-800">Clerk/Steno</p>
                                    <p class="text-xs text-purple-600">Administrative staff</p>
                                </div>
                            </div>
                            <span class="font-bold text-2xl text-purple-600" id="clerkCount">0</span>
                        </div>

                        <div class="flex justify-between items-center p-3 bg-orange-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-hands-helping text-orange-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-orange-800">Peon/Driver</p>
                                    <p class="text-xs text-orange-600">Support staff</p>
                                </div>
                            </div>
                            <span class="font-bold text-2xl text-orange-600" id="peonCount">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exchange-alt text-indigo-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-indigo-800">Transferred</p>
                                    <p class="text-xs text-indigo-600">स्थानांतरित सदस्य</p>
                                </div>
                            </div>
                            <span class="font-bold text-2xl text-indigo-600" id="transferredCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Statistics -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="font-bold text-gray-800 text-xl mb-6">
                        <i class="fas fa-chart-pie mr-3"></i>Quick Statistics
                    </h3>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Monthly Collection Potential</span>
                                <span class="font-bold" id="monthlyPotential">₹24,000</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="monthlyProgress" class="bg-green-500 h-3 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Retirement Status</span>
                                <span class="font-bold" id="retirementStatus">0 Retiring</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-center text-xs mb-3">
                                <div class="bg-green-100 text-green-800 p-2 rounded cursor-pointer hover:bg-green-200" 
                                     onclick="showRetirementDetails('active')" title="Click to view active members">
                                    <div id="activeCount">0</div>
                                    <div class="text-xs">Active</div>
                                </div>
                                <div class="bg-yellow-100 text-yellow-800 p-2 rounded cursor-pointer hover:bg-yellow-200" 
                                     onclick="showRetirementDetails('retiring-soon')" title="Click to view retiring soon members">
                                    <div id="retiringSoonCount">0</div>
                                    <div class="text-xs">Soon</div>
                                </div>
                                <div class="bg-red-100 text-red-800 p-2 rounded cursor-pointer hover:bg-red-200" 
                                     onclick="showRetirementDetails('retired')" title="Click to view retired members">
                                    <div id="retiredCount">0</div>
                                    <div class="text-xs">Retired</div>
                                </div>
                                <div class="bg-indigo-100 text-indigo-800 p-2 rounded cursor-pointer hover:bg-indigo-200" 
                                     onclick="showTransferredMembers()" title="Click to view transferred members">
                                    <div id="transferredStatCount">0</div>
                                    <div class="text-xs">Transferred</div>
                                </div>
                            </div>
                            
                            <!-- Retiring Soon Details -->
                            <div id="retiringSoonDetails" class="mt-4 hidden">
                                <h4 class="font-semibold text-yellow-800 mb-2 text-sm">
                                    <i class="fas fa-clock mr-1"></i> Retiring Soon Members
                                </h4>
                                <div class="max-h-32 overflow-y-auto border border-yellow-200 rounded-lg p-2" id="retiringSoonList">
                                    <!-- Dynamic content will be added here -->
                                </div>
                            </div>
                            
                            <!-- Retired Details -->
                            <div id="retiredDetails" class="mt-4 hidden">
                                <h4 class="font-semibold text-red-800 mb-2 text-sm">
                                    <i class="fas fa-user-clock mr-1"></i> Retired Members
                                </h4>
                                <div class="max-h-32 overflow-y-auto border border-red-200 rounded-lg p-2" id="retiredList">
                                    <!-- Dynamic content will be added here -->
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">System Info</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Members:</span>
                                    <span class="font-semibold" id="totalMembersCount">120</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Monthly Fee:</span>
                                    <span class="font-semibold">₹100</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">With Phone:</span>
                                    <span class="font-semibold" id="withPhoneCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Data Updated:</span>
                                    <span class="font-semibold" id="lastUpdated">Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-12">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-bold">DGST Welfare Society</h3>
                        <p class="text-gray-400 text-sm">120 Members | Version 3.8 - Enhanced Receipt System</p>
                    </div>
                    <div class="text-center md:text-right">
                        <p class="text-gray-400 text-sm">
                            <i class="fas fa-calendar-alt mr-1"></i> 
                            Current Month: <span id="currentMonthYearFooter">December 2025 - January 2026</span>
                        </p>
                        <p class="text-gray-400 text-sm mt-1">
                            <i class="fas fa-users mr-1"></i> 
                            Complete Members Directory | Real-time Tracking
                        </p>
                        <p class="text-gray-400 text-sm mt-1">
                            <i class="fas fa-receipt mr-1"></i> 
                            Enhanced Receipt Generation with WhatsApp Share
                        </p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700 text-center">
                    <p class="text-xs text-gray-400">
                        <strong>महत्वपूर्ण सूचना:</strong> कल्याणकारी योजनाओं का लाभ प्राप्त करने के लिए सदस्य का नियमित मासिक अंशदान अनिवार्य है।
                    </p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden fade-in">
            <div class="p-6 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                <h3 class="text-xl font-bold" id="modalTitle">Modal Title</h3>
                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]" id="modalContent">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg z-50 max-w-md">
        <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-green-400" id="toastIcon"></i>
            <div>
                <p class="font-semibold" id="toastTitle">Success</p>
                <p class="text-sm text-gray-300" id="toastMessage">Operation completed successfully</p>
            </div>
        </div>
    </div>
    
    <script>
        // ====================
        // APPLICATION CONFIGURATION
        // ====================
        const CONFIG = {
            MONTHLY_CONTRIBUTION: 100,
            DATA_KEY: 'dgst_welfare_complete_v3_8',
            PASSWORDS_KEY: 'dgst_welfare_passwords_v3',
            VERSION: '3.8 - Enhanced Receipt System',
            
            // Society Details for Receipt
            SOCIETY_NAME: 'DGST Welfare Society',
            SOCIETY_ADDRESS: 'DGST Office, Government Building',
            SOCIETY_CITY: 'City, State - PIN CODE',
            SOCIETY_CONTACT: 'Phone: 1234567890',
            SOCIETY_SEAL: 'OFFICIAL SEAL',
            
            // Welfare Schemes
            WELFARE_SCHEMES: {
                RETIREMENT_HONOR: {
                    name: 'सेवानिवृत्ति सम्मान समारोह',
                    description: 'सदस्य की सेवानिवृत्ति के उपलक्ष्य में कल्याणकारी सभा द्वारा विदाई एवं सम्मान समारोह का आयोजन किया जाएगा।',
                    icon: 'fa-user-tie'
                },
                SON_MARRIAGE: {
                    name: 'पुत्र विवाह हेतु आर्थिक सहायता',
                    description: 'सदस्य के पुत्र के शुभ विवाह के अवसर पर सभा की ओर से ₹3,100/- (तीन हज़ार एक सौ रुपये मात्र) की आर्थिक सहायता प्रदान की जाएगी।',
                    amount: 3100,
                    icon: 'fa-male'
                },
                DAUGHTER_MARRIAGE: {
                    name: 'पुत्री विवाह हेतु आर्थिक सहायता',
                    description: 'सदस्य की पुत्री के शुभ विवाह के अवसर पर सभा की ओर से ₹5,100/- (पाँच हज़ार एक सौ रुपये मात्र) की आर्थिक सहायता प्रदान की जाएगी।',
                    amount: 5100,
                    icon: 'fa-female'
                },
                CONDOLENCE: {
                    name: 'शोक सहायता राशि',
                    description: 'सदस्य के असामयिक निधन की दुःखद स्थिति में उनके आश्रित परिवार को कल्याणकारी सभा द्वारा ₹11,000/- (ग्यारह हज़ार रुपये मात्र) की आर्थिक सहायता प्रदान की जाएगी।',
                    amount: 11000,
                    icon: 'fa-hands-helping'
                },
                TRANSFER_MEMENTO: {
                    name: 'स्थानांतरण स्मृति चिन्ह',
                    description: 'यदि कोई सदस्य स्थायी रूप से अन्य विभाग में स्थानांतरित होता है, तो उसे परिवहन विभाग की ओर से स्मृति चिन्ह (Memento) एवं सफारी सूट (बिना सिला हुआ) भेंट किया जाएगा। बिना अंशदान वाले अधिकारियों जैसे DGST, ADST को केवल स्मृति चिन्ह (Memento) ही प्रदान किया जाएगा।',
                    icon: 'fa-gift'
                }
            }
        };

        // ====================
        // USER ROLES AND AUTHENTICATION
        // ====================
        const USER_ROLES = {
            ADMIN: 'admin',
            VIEWER: 'viewer'
        };

        // Default passwords
        const DEFAULT_PASSWORDS = {
            admin: 'Land3050',
            viewer: 'Land5070'
        };

        // ====================
        // GLOBAL VARIABLES
        // ====================
        let currentUser = '';
        let currentUserRole = '';
        let employees = [];
        let payments = [];
        let withdrawals = [];
        let activities = [];
        let receiptCounter = 1000;
        let withdrawalReceiptCounter = 2000;
        let passwords = { ...DEFAULT_PASSWORDS };

        // ====================
        // COMPLETE 120 MEMBERS DATA
        // ====================
        const DEFAULT_EMPLOYEES = [
            {id: 1, name: 'Baljit', designation: 'Assistant', phone: '', joinDate: '2025-11-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 2, name: 'Sunil Hooda', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 3, name: 'Vikas Gujjar', designation: 'Junior Auditor', phone: '9915319516', joinDate: '2025-12-01', retirementDate: '2048-10-31', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 4, name: 'Bharat', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 5, name: 'Aman', designation: 'DEO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 6, name: 'Dalpat', designation: 'Deputy Superintendent', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 7, name: 'Pardeep Nazar', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 8, name: 'Nirmal', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 9, name: 'Anil', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 10, name: 'Sunita', designation: 'Superintendent', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 11, name: 'Bijender', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 12, name: 'Munish', designation: 'Steno Typist', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 13, name: 'Dilawar', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 14, name: 'Anil', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 15, name: 'Sarwjeet Kaur', designation: 'Superintendent', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 16, name: 'Anoop Singh', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 17, name: 'Rakesh', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 18, name: 'Rajesh', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 19, name: 'Rajesh Yadav', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 20, name: 'Jaideep', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 21, name: 'Ajay', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 22, name: 'Sombir Rana', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 23, name: 'Vikash Choudhary', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 24, name: 'Rakesh Lambu', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 25, name: 'Urmila', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 26, name: 'Manmohan', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 27, name: 'Soma', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 28, name: 'Sanjay', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 29, name: 'Naveen', designation: 'DEO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 30, name: 'Renu', designation: 'Assistant', phone: '9478753181', joinDate: '2025-12-01', retirementDate: '2034-03-31', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 31, name: 'Ravinder Kumar', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 32, name: 'Shamarta', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 33, name: 'Raman', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 34, name: 'Rajeev', designation: 'Steno Typist', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 35, name: 'Bharat Soni', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 36, name: 'Parvesh', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 37, name: 'Sakuntla', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '2025-12-31', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 38, name: 'Ashwini', designation: 'Assistant', phone: '8930910419', joinDate: '2025-12-01', retirementDate: '2054-04-30', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 39, name: 'Manoj Kumar', designation: 'Accountant', phone: '', joinDate: '2025-12-01', retirementDate: '2045-07-31', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 40, name: 'Anuj Kundu', designation: 'Junior Auditor', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 41, name: 'Raj Kumar', designation: 'Steno Typist', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 42, name: 'Pardeep Pannu', designation: 'DEO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 43, name: 'Sushil', designation: 'Clerk', phone: '9053919108', joinDate: '2025-12-01', retirementDate: '2049-04-30', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 44, name: 'Sarbjit Singh Mann', designation: 'DTC', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 45, name: 'Darshan Walia', designation: 'Deputy Superintendent', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 46, name: 'Dinesh', designation: 'Assistant', phone: '9041802020', joinDate: '2025-12-01', retirementDate: '2052-01-31', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 47, name: 'Suman', designation: 'Accountant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 48, name: 'Vikash', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 49, name: 'Gogi', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 50, name: 'Ranjana Sharma', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 51, name: 'Deepak', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 52, name: 'Saqib', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 53, name: 'Shalu', designation: 'Steno Typist', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 54, name: 'Shallender Singh', designation: 'A/C', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 55, name: 'Amit', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 56, name: 'Vinod Kumar', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 57, name: 'JatindarPal', designation: 'Deputy Superintendent', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 58, name: 'Shukhwinder Kaur', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 59, name: 'Rohit', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 60, name: 'Ramesh', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 61, name: 'Pawan', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 62, name: 'Suman Sawroop', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 63, name: 'Ram Bahadur', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 64, name: 'Surender', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 65, name: 'Sanjay', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 66, name: 'Sanjeev', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 67, name: 'Sushil', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 68, name: 'Kamal Preet', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 69, name: 'Anil', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 70, name: 'Sudha Rani', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 71, name: 'Sushma', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 72, name: 'Pavlt', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 73, name: 'Sandesp', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 74, name: 'Ravinder Mohan', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 75, name: 'Rahul', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 76, name: 'Vinod Kumar', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 77, name: 'Neeraj', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 78, name: 'Banty', designation: 'Steno Typsi', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 79, name: 'Mulesh', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 80, name: 'Mohit', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 81, name: 'Arun', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 82, name: 'Devender', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 83, name: 'Balkar', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 84, name: 'Parmila', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 85, name: 'SP Parmar', designation: 'JSS', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 86, name: 'Shri Bhagwan', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 87, name: 'Geelu Rani', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 88, name: 'Manisha', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 89, name: 'Naresh Goyal', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 90, name: 'Amit', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 91, name: 'Bijender Hooda', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 92, name: 'Jagbir', designation: 'Accountant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 93, name: 'Manoj Kumar', designation: 'Clerk', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 94, name: 'Suman', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 95, name: 'Meenakshi Rani', designation: 'Steno Typsi', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 96, name: 'Anil', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 97, name: 'Pavlinder', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 98, name: 'Babia Sharma', designation: 'PA', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 99, name: 'Pardeep Phogat', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 100, name: 'Satish', designation: 'Accountant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 101, name: 'Charan Das', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 102, name: 'Jain', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 103, name: 'Rothas', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 104, name: 'Neelam', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 105, name: 'Satish Jangra', designation: 'SSS', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 106, name: 'Chand Singh', designation: 'Helper', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 107, name: 'Monu', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 108, name: 'Jasvir Kaur', designation: 'DECO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 109, name: 'Pawan', designation: 'Assistant', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 110, name: 'Pawan Farsa', designation: 'Steno Typsi', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 111, name: 'Kuldsep', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 112, name: 'Karam Singh', designation: 'Peon', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 113, name: 'Khem', designation: 'Driver', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 114, name: 'Kudeep', designation: 'Driver', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 115, name: 'Karamveer', designation: 'Driver', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 116, name: 'Amitk Singh', designation: 'Driver', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 117, name: 'Vijay', designation: 'Driver', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 118, name: 'Upasana', designation: 'DEO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 119, name: 'Muniya', designation: 'DEO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''},
            {id: 120, name: 'Parmila', designation: 'DEO', phone: '', joinDate: '2025-12-01', retirementDate: '', 
             monthlyReceivable: 0, totalReceived: 0, currentMonthReceivable: 0, lastUpdatedMonth: '', deleted: false, parked: false, status: 'active', transferred: false, transferDate: ''}
        ];

        // ====================
        // BASIC FUNCTIONS
        // ====================
        function showToast(title, message, type = 'success') {
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colorMap = {
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                info: 'text-blue-400'
            };
            
            document.getElementById('toastIcon').className = `fas ${iconMap[type]} ${colorMap[type]}`;
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            const toast = document.getElementById('toast');
            toast.classList.remove('hidden');
            toast.classList.add('undo-toast');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function formatCurrency(amount) {
            return '₹' + amount.toLocaleString('en-IN');
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        // ====================
        // MODAL FUNCTIONS
        // ====================
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ====================
        // DATA MANAGEMENT
        // ====================
        async function loadData() {
            // First try to load from Firebase if enabled
            if (window.firebaseEnabled && window.loadFromFirebase) {
                try {
                    const firebaseData = await window.loadFromFirebase(CONFIG.DATA_KEY);
                    if (firebaseData) {
                        employees = firebaseData.employees || DEFAULT_EMPLOYEES;
                        payments = firebaseData.payments || [];
                        withdrawals = firebaseData.withdrawals || [];
                        activities = firebaseData.activities || [];
                        receiptCounter = firebaseData.receiptCounter || 1000;
                        withdrawalReceiptCounter = firebaseData.withdrawalReceiptCounter || 2000;

                        // Also update localStorage with Firebase data
                        localStorage.setItem(CONFIG.DATA_KEY, JSON.stringify(firebaseData));
                        console.log('Data loaded from Firebase');
                        updateDashboard();
                        return;
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                }
            }

            // Fallback to localStorage
            const saved = localStorage.getItem(CONFIG.DATA_KEY);

            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    employees = data.employees || DEFAULT_EMPLOYEES;
                    payments = data.payments || [];
                    withdrawals = data.withdrawals || [];
                    activities = data.activities || [];
                    receiptCounter = data.receiptCounter || 1000;
                    withdrawalReceiptCounter = data.withdrawalReceiptCounter || 2000;
                } catch (e) {
                    console.error('Error loading data:', e);
                    initializeDefaultData();
                }
            } else {
                initializeDefaultData();
            }

            updateDashboard();
        }

        function saveData() {
            const data = {
                employees,
                payments,
                withdrawals,
                activities,
                receiptCounter,
                withdrawalReceiptCounter,
                version: CONFIG.VERSION,
                lastUpdated: new Date().toISOString()
            };

            // Save to localStorage (always works offline)
            localStorage.setItem(CONFIG.DATA_KEY, JSON.stringify(data));
            updateLastUpdated();

            // Also sync to Firebase if enabled
            if (window.firebaseEnabled && window.syncToFirebase) {
                window.syncToFirebase(CONFIG.DATA_KEY, data).then(success => {
                    if (success) {
                        showFirebaseSyncStatus(true);
                    }
                }).catch(error => {
                    console.error('Firebase sync error:', error);
                    showFirebaseSyncStatus(false);
                });
            }
        }

        // Helper function to show sync status
        function showFirebaseSyncStatus(success) {
            const statusEl = document.getElementById('firebaseSyncStatus');
            if (statusEl) {
                if (success) {
                    statusEl.innerHTML = '<i class="fas fa-cloud text-green-500 mr-1"></i><span class="text-green-600 text-xs">Synced</span>';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-cloud text-yellow-500 mr-1"></i><span class="text-yellow-600 text-xs">Offline</span>';
                }
            }
        }

        function initializeDefaultData() {
            employees = DEFAULT_EMPLOYEES;
            payments = [];
            withdrawals = [];
            activities = [{
                id: Date.now(),
                user: 'System',
                action: `System initialized with ${DEFAULT_EMPLOYEES.length} members`,
                timestamp: new Date().toISOString()
            }];
            
            saveData();
        }

        // ====================
        // ENHANCED: MEMBER FINANCIAL CALCULATION (FIXED)
        // ====================
        function calculateMemberCurrentReceivable(member) {
            const monthlyFee = CONFIG.MONTHLY_CONTRIBUTION;
            const joinDate = new Date(member.joinDate);
            const currentDate = new Date();
            
            if (joinDate > currentDate) {
                return {
                    totalReceivableFromJoining: 0,
                    totalReceived: member.totalReceived || 0,
                    currentReceivable: 0,
                    totalPending: 0,
                    monthsPaid: 0,
                    totalMonthsDue: 0,
                    monthsPending: 0
                };
            }
            
            // Calculate total months from joining to current month (inclusive)
            const joinYear = joinDate.getFullYear();
            const joinMonth = joinDate.getMonth();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            
            let totalMonths = (currentYear - joinYear) * 12 + (currentMonth - joinMonth) + 1;
            
            // If join date is later in the month, adjust
            if (joinDate.getDate() > currentDate.getDate()) {
                totalMonths -= 1;
            }
            
            // Ensure at least 1 month
            totalMonths = Math.max(1, totalMonths);
            
            // Calculate total receivable from joining till now
            const totalReceivableFromJoining = totalMonths * monthlyFee;
            
            // Get member's total payments
            const memberPayments = payments.filter(p => p.employeeId === member.id);
            const totalReceived = memberPayments.reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate total pending (all months)
            const totalPending = Math.max(0, totalReceivableFromJoining - totalReceived);
            
            // Calculate months paid
            const monthsPaid = Math.floor(totalReceived / monthlyFee);
            
            return {
                totalReceivableFromJoining,
                totalReceived,
                currentReceivable: totalPending, // This is TOTAL pending, not just current month
                totalPending,
                monthsPaid,
                totalMonthsDue: totalMonths,
                monthsPending: totalMonths - monthsPaid
            };
        }

        function updateMemberCurrentReceivable(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            const calculation = calculateMemberCurrentReceivable(employees[memberIndex]);
            
            employees[memberIndex] = {
                ...employees[memberIndex],
                monthlyReceivable: CONFIG.MONTHLY_CONTRIBUTION,
                currentMonthReceivable: calculation.currentReceivable,
                totalReceived: calculation.totalReceived,
                lastUpdatedMonth: getCurrentMonthYear()
            };
            
            return calculation;
        }

        // ====================
        // ENHANCED DASHBOARD FUNCTIONS
        // ====================
        function calculateCurrentBalance() {
            const totalReceived = payments.reduce((sum, p) => sum + p.amount, 0);
            const totalWithdrawn = withdrawals.reduce((sum, w) => sum + w.amount, 0);
            return totalReceived - totalWithdrawn;
        }

        function updateDashboard() {
            const currentMonthYear = getCurrentMonthYear();
            
            document.getElementById('currentMonthYear').textContent = currentMonthYear;
            document.getElementById('currentMonthYearFooter').textContent = currentMonthYear;
            
            const activeEmployees = employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired' && !emp.transferred);
            
            const totalMembers = employees.filter(emp => !emp.deleted).length;
            let currentReceivable = 0;
            let currentMonthReceived = 0;
            let totalReceivableFromAll = 0;
            let totalReceivedFromAll = 0;
            
            activeEmployees.forEach(emp => {
                const calculation = calculateMemberCurrentReceivable(emp);
                
                emp.currentMonthReceivable = calculation.currentReceivable;
                emp.totalReceived = calculation.totalReceived;
                
                currentReceivable += calculation.currentReceivable;
                totalReceivableFromAll += calculation.totalReceivableFromJoining;
                totalReceivedFromAll += calculation.totalReceived;
                
                const currentYearMonth = new Date().toISOString().substring(0, 7);
                const memberPayments = payments.filter(p => 
                    p.employeeId === emp.id && 
                    p.date.startsWith(currentYearMonth)
                );
                currentMonthReceived += memberPayments.reduce((sum, p) => sum + p.amount, 0);
            });
            
            const currentMonthWithdrawn = withdrawals
                .filter(w => w.monthYear === currentMonthYear)
                .reduce((sum, w) => sum + w.amount, 0);
            
            const currentBalance = calculateCurrentBalance();
            
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('totalMembersCount').textContent = totalMembers;
            document.getElementById('totalReceivable').textContent = formatCurrency(currentReceivable);
            document.getElementById('currentMonthReceivable').textContent = formatCurrency(currentReceivable);
            document.getElementById('currentMonthReceived').textContent = formatCurrency(currentMonthReceived);
            document.getElementById('currentMonthWithdrawn').textContent = formatCurrency(currentMonthWithdrawn);
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
            
            let pendingCount = 0;
            activeEmployees.forEach(emp => {
                if (emp.currentMonthReceivable > 0) {
                    pendingCount++;
                }
            });
            
            document.getElementById('pendingMembers').textContent = pendingCount;
            document.getElementById('totalReceived').textContent = formatCurrency(currentMonthReceived);
            
            const collectionPercentage = currentReceivable > 0 ? 
                (currentMonthReceived / currentReceivable * 100) : 0;
            document.getElementById('collectionProgress').style.width = `${Math.min(100, collectionPercentage)}%`;
            
            updateRecentPayments();
            updateRecentWithdrawals();
            updateRetirementStatus();
            updateDesignationCounts();
            
            const withPhoneCount = employees.filter(emp => !emp.deleted && emp.phone && emp.phone.length >= 10).length;
            document.getElementById('withPhoneCount').textContent = withPhoneCount;
            
            document.getElementById('monthlyPotential').textContent = formatCurrency(currentReceivable);
            const monthlyPercentage = currentReceivable > 0 ? 
                (currentMonthReceived / currentReceivable * 100) : 0;
            document.getElementById('monthlyProgress').style.width = `${Math.min(100, monthlyPercentage)}%`;
            
            saveData();
        }

        function getCurrentMonthYear() {
            const now = new Date();
            const currentMonth = now.toLocaleString('default', { month: 'long' });
            const currentYear = now.getFullYear();
            return `${currentMonth} ${currentYear}`;
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { hour12: true, hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdated').textContent = `Today at ${timeStr}`;
        }

        function updateRecentPayments() {
            const recentPaymentsContainer = document.getElementById('recentPayments');
            const recentPayments = payments.slice(-5).reverse();
            
            if (recentPayments.length === 0) {
                recentPaymentsContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-inbox text-2xl"></i>
                        <p class="mt-2">No recent payments</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            recentPayments.forEach(payment => {
                const member = employees.find(emp => emp.id === payment.employeeId);
                html += `
                    <div class="border border-green-200 rounded-lg p-4 hover:bg-green-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${member ? member.name : payment.employeeName}</p>
                                <p class="text-sm text-gray-600">${member ? member.designation : '-'}</p>
                                <p class="text-xs text-gray-500 mt-1">Receipt: ${payment.receiptNo}</p>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-green-700">${formatCurrency(payment.amount)}</span>
                                <p class="text-xs text-gray-600 mt-1">${formatDate(payment.date)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recentPaymentsContainer.innerHTML = html;
        }

        function updateRecentWithdrawals() {
            const recentWithdrawalsContainer = document.getElementById('recentWithdrawals');
            const recentWithdrawals = withdrawals.slice(-5).reverse();
            
            if (recentWithdrawals.length === 0) {
                recentWithdrawalsContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i class="fas fa-inbox text-2xl"></i>
                        <p class="mt-2">No recent withdrawals</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            recentWithdrawals.forEach(withdrawal => {
                html += `
                    <div class="border border-red-200 rounded-lg p-4 hover:bg-red-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${withdrawal.purpose}</p>
                                <p class="text-sm text-gray-600">${withdrawal.category}</p>
                                <p class="text-xs text-gray-500 mt-1">Receipt: ${withdrawal.receiptNo}</p>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-red-700">${formatCurrency(withdrawal.amount)}</span>
                                <p class="text-xs text-gray-600 mt-1">${formatDate(withdrawal.date)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recentWithdrawalsContainer.innerHTML = html;
        }

        function updateRetirementStatus() {
            const now = new Date();
            const retiredEmployees = employees.filter(emp => emp.status === 'retired');
            
            const retiringSoonEmployees = employees.filter(emp => {
                if (!emp.retirementDate || emp.deleted || emp.parked || emp.status === 'retired' || emp.transferred) return false;
                const retirementDate = new Date(emp.retirementDate);
                const sixMonthsFromNow = new Date();
                sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);
                return retirementDate <= sixMonthsFromNow && retirementDate > now;
            });
            
            const activeCount = employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired' && !emp.transferred).length;
            
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('retiredCount').textContent = retiredEmployees.length;
            document.getElementById('retiringSoonCount').textContent = retiringSoonEmployees.length;
            document.getElementById('retirementStatus').textContent = `${retiringSoonEmployees.length} Retiring Soon`;
        }

        function updateDesignationCounts() {
            const activeEmployees = employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired' && !emp.transferred);
            const transferredEmployees = employees.filter(emp => !emp.deleted && emp.transferred);
            
            const assistantCount = activeEmployees.filter(emp => 
                emp.designation.toLowerCase().includes('assistant') || 
                emp.designation.toLowerCase().includes('pa')
            ).length;
            
            const accountantCount = activeEmployees.filter(emp => 
                emp.designation.toLowerCase().includes('accountant') || 
                emp.designation.toLowerCase().includes('auditor') ||
                emp.designation.toLowerCase().includes('a/c')
            ).length;
            
            const clerkCount = activeEmployees.filter(emp => 
                emp.designation.toLowerCase().includes('clerk') || 
                emp.designation.toLowerCase().includes('steno') ||
                emp.designation.toLowerCase().includes('deo') ||
                emp.designation.toLowerCase().includes('deco') ||
                emp.designation.toLowerCase().includes('typist')
            ).length;
            
            const peonCount = activeEmployees.filter(emp => 
                emp.designation.toLowerCase().includes('peon') || 
                emp.designation.toLowerCase().includes('driver') ||
                emp.designation.toLowerCase().includes('helper')
            ).length;
            
            const transferredCount = transferredEmployees.length;
            
            document.getElementById('assistantCount').textContent = assistantCount;
            document.getElementById('accountantCount').textContent = accountantCount;
            document.getElementById('clerkCount').textContent = clerkCount;
            document.getElementById('peonCount').textContent = peonCount;
            document.getElementById('transferredCount').textContent = transferredCount;
            document.getElementById('transferredStatCount').textContent = transferredCount;
        }

        // ====================
        // ENHANCED: PAYMENT PROCESS WITH RECEIPT
        // ====================
        function showQuickPaymentModal() {
            if (currentUserRole === USER_ROLES.VIEWER) {
                showToast('Access Denied', 'Viewer cannot add payments', 'error');
                return;
            }
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Add Payment</h3>
                                <p class="opacity-90">Record payment from member with receipt</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Member</label>
                            <select id="paymentMemberSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">-- Select Member --</option>
                                ${employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired').map(emp => {
                                    const calculation = calculateMemberCurrentReceivable(emp);
                                    return `<option value="${emp.id}" data-balance="${calculation.currentReceivable}">${emp.name} - ${emp.designation} (Due: ${formatCurrency(calculation.currentReceivable)})</option>`;
                                }).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Amount (₹)</label>
                            <input type="number" id="paymentAmount" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="100" value="100" min="1" step="1">
                            <p class="text-xs text-gray-500 mt-1">Suggested: ₹100 (Monthly Contribution)</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Date</label>
                            <input type="date" id="paymentDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Mode</label>
                            <select id="paymentMode" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="UPI">UPI</option>
                                <option value="Cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Remarks</label>
                        <textarea id="paymentRemarks" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" rows="3" placeholder="Monthly contribution for ${getCurrentMonthYear()}..."></textarea>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">Member's Current Status</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Selected Member:</span>
                                <span class="font-semibold" id="selectedMemberName">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Current Due:</span>
                                <span class="font-semibold" id="selectedMemberDue">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="processPayment()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700">
                            <i class="fas fa-check-circle mr-2"></i>Save Payment & Generate Receipt
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Add Payment', html);
            
            document.getElementById('paymentMemberSelect').addEventListener('change', function() {
                const memberId = parseInt(this.value);
                if (memberId) {
                    const member = employees.find(emp => emp.id === memberId);
                    if (member) {
                        const calculation = calculateMemberCurrentReceivable(member);
                        document.getElementById('selectedMemberName').textContent = member.name;
                        document.getElementById('selectedMemberDue').textContent = formatCurrency(calculation.currentReceivable);
                        document.getElementById('paymentAmount').value = Math.min(calculation.currentReceivable, 100) || 100;
                    }
                } else {
                    document.getElementById('selectedMemberName').textContent = '-';
                    document.getElementById('selectedMemberDue').textContent = '-';
                }
            });
        }

        function processPayment() {
            const memberId = parseInt(document.getElementById('paymentMemberSelect').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const mode = document.getElementById('paymentMode').value;
            const remarks = document.getElementById('paymentRemarks').value;
            
            if (!memberId || !amount || !date) {
                showToast('Error', 'Please fill all required fields', 'error');
                return;
            }
            
            if (amount <= 0) {
                showToast('Error', 'Amount must be greater than 0', 'error');
                return;
            }
            
            const member = employees.find(emp => emp.id === memberId);
            if (!member) {
                showToast('Error', 'Member not found', 'error');
                return;
            }
            
            const beforePayment = calculateMemberCurrentReceivable(member);
            
            const payment = {
                id: Date.now(),
                employeeId: memberId,
                employeeName: member.name,
                amount: amount,
                date: date,
                mode: mode,
                remarks: remarks,
                receiptNo: `RCPT${receiptCounter++}`,
                timestamp: new Date().toISOString(),
                addedBy: currentUser
            };
            
            payments.push(payment);
            
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex !== -1) {
                employees[memberIndex].totalReceived = (employees[memberIndex].totalReceived || 0) + amount;
                
                const afterPayment = calculateMemberCurrentReceivable(employees[memberIndex]);
                employees[memberIndex].currentMonthReceivable = afterPayment.currentReceivable;
            }
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Added payment of ${formatCurrency(amount)} from ${member.name} (Receipt: ${payment.receiptNo})`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            
            showPaymentReceipt(payment, member, beforePayment);
            
            showToast('Success', `Payment of ${formatCurrency(amount)} recorded for ${member.name}`, 'success');
        }

        // ====================
        // ENHANCED: PAYMENT RECEIPT GENERATION
        // ====================
        function showPaymentReceipt(payment, member, beforeCalculation) {
            const calculation = calculateMemberCurrentReceivable(member);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-receipt text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Payment Receipt</h3>
                                <p class="opacity-90">Receipt No: ${payment.receiptNo}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Receipt Print Area -->
                    <div id="receiptPrintArea" class="receipt-container bg-white p-8 rounded-lg border-2 border-gray-300">
                        <div class="watermark">DGST WELFARE</div>
                        
                        <div class="receipt-header">
                            <h2 class="text-3xl font-bold">${CONFIG.SOCIETY_NAME}</h2>
                            <p class="text-lg">${CONFIG.SOCIETY_ADDRESS}</p>
                            <p class="text-lg">${CONFIG.SOCIETY_CITY}</p>
                            <p class="text-lg">${CONFIG.SOCIETY_CONTACT}</p>
                            <div class="border-t-2 border-black my-4 pt-2">
                                <h3 class="text-2xl font-bold">PAYMENT RECEIPT</h3>
                                <p class="text-lg">Original Copy</p>
                            </div>
                        </div>
                        
                        <div class="receipt-amount">
                            Amount Received: ${formatCurrency(payment.amount)}
                        </div>
                        
                        <div class="receipt-details mt-6">
                            <table class="receipt-table">
                                <tr>
                                    <th colspan="2" class="text-center bg-gray-100">Receipt Details</th>
                                </tr>
                                <tr>
                                    <td class="font-bold">Receipt Number:</td>
                                    <td>${payment.receiptNo}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Date:</td>
                                    <td>${formatDate(payment.date)}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Payment Mode:</td>
                                    <td>${payment.mode}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Received By:</td>
                                    <td>${payment.addedBy || 'Society Treasurer'}</td>
                                </tr>
                            </table>
                            
                            <table class="receipt-table mt-4">
                                <tr>
                                    <th colspan="2" class="text-center bg-gray-100">Member Details</th>
                                </tr>
                                <tr>
                                    <td class="font-bold">Member ID:</td>
                                    <td>${member.id}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Member Name:</td>
                                    <td>${member.name}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Designation:</td>
                                    <td>${member.designation}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Phone:</td>
                                    <td>${member.phone || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Joining Date:</td>
                                    <td>${formatDate(member.joinDate)}</td>
                                </tr>
                                ${member.retirementDate ? `
                                <tr>
                                    <td class="font-bold">Retirement Date:</td>
                                    <td>${formatDate(member.retirementDate)}</td>
                                </tr>
                                ` : ''}
                            </table>
                            
                            <table class="receipt-table mt-4">
                                <tr>
                                    <th colspan="2" class="text-center bg-gray-100">Financial Summary</th>
                                </tr>
                                <tr>
                                    <td class="font-bold">Monthly Contribution:</td>
                                    <td>${formatCurrency(CONFIG.MONTHLY_CONTRIBUTION)}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Total Months Since Joining:</td>
                                    <td>${calculation.totalMonthsDue} months</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Total Receivable (From Joining):</td>
                                    <td>${formatCurrency(calculation.totalReceivableFromJoining)}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Total Paid Till Now:</td>
                                    <td class="amount-paid">${formatCurrency(calculation.totalReceived)}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Total Pending:</td>
                                    <td class="amount-pending">${formatCurrency(calculation.totalPending)}</td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Current Due:</td>
                                    <td class="${calculation.currentReceivable > 0 ? 'amount-pending' : 'amount-paid'}">
                                        ${formatCurrency(calculation.currentReceivable)}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-bold">Months Paid:</td>
                                    <td>${calculation.monthsPaid} / ${calculation.totalMonthsDue} months</td>
                                </tr>
                            </table>
                            
                            <div class="mt-6">
                                <p><strong>Remarks:</strong> ${payment.remarks || 'Monthly Contribution'}</p>
                            </div>
                        </div>
                        
                        <div class="receipt-footer mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <p class="font-bold">Received By:</p>
                                    <p>${payment.addedBy || 'Society Treasurer'}</p>
                                    <div class="border-t border-black w-48 mt-2 pt-2"></div>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold">Authorized Signature</p>
                                    <div class="receipt-stamp">
                                        ${CONFIG.SOCIETY_SEAL}
                                    </div>
                                </div>
                                <div>
                                    <p class="font-bold">Member Signature</p>
                                    <div class="border-t border-black w-48 mt-2 pt-2"></div>
                                </div>
                            </div>
                            
                            <p class="text-sm text-center text-gray-600 mt-6">
                                <strong>Note:</strong> This is a computer generated receipt. No signature required.
                            </p>
                            <p class="text-sm text-center text-gray-600">
                                कृपया इस रसीद को सुरक्षित रखें। भविष्य के संदर्भ के लिए आवश्यक है।
                            </p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                        <button onclick="printReceipt()" class="download-btn">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        
                        <button onclick="downloadReceiptAsPDF('${member.name}', '${payment.receiptNo}')" class="download-btn" style="background-color: #3b82f6;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        
                        <button onclick="shareReceiptViaWhatsApp('${member.name}', '${payment.receiptNo}', '${payment.amount}', '${payment.date}', '${calculation.currentReceivable}', '${member.phone}')" 
                                class="whatsapp-share-btn">
                            <i class="fab fa-whatsapp"></i> Share via WhatsApp
                        </button>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Payment Receipt', html);
        }

        function printReceipt() {
            const printContent = document.getElementById('receiptPrintArea').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            loadMainApplication();
        }

        function downloadReceiptAsPDF(memberName, receiptNo) {
            const element = document.getElementById('receiptPrintArea');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 190;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`Receipt_${receiptNo}_${memberName}.pdf`);
                
                showToast('Success', 'Receipt downloaded as PDF', 'success');
            }).catch(error => {
                console.error('PDF generation error:', error);
                showToast('Error', 'Failed to generate PDF', 'error');
            });
        }

        function shareReceiptViaWhatsApp(memberName, receiptNo, amount, date, pending, phone) {
            const formattedDate = formatDate(date);
            const message = `*DGST Welfare Society - Payment Receipt*

*Receipt No:* ${receiptNo}
*Date:* ${formattedDate}
*Member:* ${memberName}
*Amount Paid:* ₹${amount}
*Pending Balance:* ₹${pending}

This is a computer generated receipt from DGST Welfare Society Monthly Tracking System.

Thank you for your contribution!`;
            
            let whatsappUrl;
            if (phone && phone.length >= 10) {
                whatsappUrl = `https://wa.me/91${phone}?text=${encodeURIComponent(message)}`;
            } else {
                whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            }
            
            window.open(whatsappUrl, '_blank');
            
            showToast('Success', 'Receipt shared via WhatsApp', 'success');
        }

        // ====================
        // ENHANCED MEMBER DETAILS VIEW
        // ====================
        function viewMemberDetails(memberId) {
            const member = employees.find(emp => emp.id === memberId);
            if (!member) return;
            
            const calculation = calculateMemberCurrentReceivable(member);
            const memberPayments = payments.filter(p => p.employeeId === memberId);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">${member.name}</h3>
                                <p class="opacity-90">${member.designation} | ID: ${member.id} | Member Since: ${formatDate(member.joinDate)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-6 rounded-xl">
                            <h4 class="font-bold text-gray-800 mb-4">Member Details</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Name:</span>
                                    <span class="font-semibold">${member.name}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Designation:</span>
                                    <span class="font-semibold">${member.designation}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Phone:</span>
                                    <span class="font-semibold">${member.phone || '-'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Joining Date:</span>
                                    <span class="font-semibold">${formatDate(member.joinDate)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Retirement Date:</span>
                                    <span class="font-semibold">${member.retirementDate ? formatDate(member.retirementDate) : '-'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Status:</span>
                                    <span class="font-semibold">
                                        ${member.status === 'retired' ? 'Retired' : 
                                          member.parked ? 'Parked' : 
                                          member.transferred ? 'Transferred' : 
                                          member.deleted ? 'Deleted' : 'Active'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-6 rounded-xl">
                            <h4 class="font-bold text-blue-800 mb-4">Financial Summary</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Monthly Contribution:</span>
                                    <span class="font-semibold">${formatCurrency(CONFIG.MONTHLY_CONTRIBUTION)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Months Since Joining:</span>
                                    <span class="font-semibold">${calculation.totalMonthsDue} months</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Receivable (From Joining):</span>
                                    <span class="font-semibold">${formatCurrency(calculation.totalReceivableFromJoining)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Paid:</span>
                                    <span class="font-semibold ${calculation.totalReceived >= calculation.totalReceivableFromJoining ? 'text-green-600' : 'text-red-600'}">
                                        ${formatCurrency(calculation.totalReceived)}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Pending:</span>
                                    <span class="font-semibold ${calculation.totalPending > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${formatCurrency(calculation.totalPending)}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Current Due:</span>
                                    <span class="font-semibold ${calculation.currentReceivable > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${formatCurrency(calculation.currentReceivable)}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Status:</span>
                                    <span class="font-semibold ${calculation.currentReceivable > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${calculation.currentReceivable > 0 ? 'Pending' : 'Up to Date'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-gray-800 mb-4">Payment History (Total: ${memberPayments.length} payments)</h4>
                        ${memberPayments.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="py-2 px-4 text-left">Date</th>
                                            <th class="py-2 px-4 text-left">Receipt No</th>
                                            <th class="py-2 px-4 text-left">Amount</th>
                                            <th class="py-2 px-4 text-left">Mode</th>
                                            <th class="py-2 px-4 text-left">Remarks</th>
                                            <th class="py-2 px-4 text-left">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${memberPayments.map(payment => `
                                            <tr class="border-b">
                                                <td class="py-2 px-4">${formatDate(payment.date)}</td>
                                                <td class="py-2 px-4">${payment.receiptNo}</td>
                                                <td class="py-2 px-4 font-semibold">${formatCurrency(payment.amount)}</td>
                                                <td class="py-2 px-4">${payment.mode}</td>
                                                <td class="py-2 px-4">${payment.remarks || '-'}</td>
                                                <td class="py-2 px-4">
                                                    <button onclick="viewPaymentReceipt(${payment.id})" class="action-btn edit-btn">
                                                        <i class="fas fa-receipt"></i> Receipt
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <p class="text-gray-500 text-center py-4">No payment history available</p>
                        `}
                    </div>
                    
                    <div class="flex gap-4">
                        ${currentUserRole === USER_ROLES.ADMIN ? `
                        <button onclick="addPaymentForMember(${member.id})" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700">
                            <i class="fas fa-money-bill-wave mr-2"></i>Add Payment
                        </button>
                        ` : ''}
                        <button onclick="generateMemberStatement(${member.id})" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-semibold hover:bg-purple-700">
                            <i class="fas fa-file-pdf mr-2"></i>Generate Statement
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Member Details', html);
        }

        function viewPaymentReceipt(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const member = employees.find(emp => emp.id === payment.employeeId);
            if (!member) return;
    
            const calculation = calculateMemberCurrentReceivable(member);
            
            showPaymentReceipt(payment, member, calculation);
        }

        function addPaymentForMember(memberId) {
            const member = employees.find(emp => emp.id === memberId);
            if (!member) return;
            
            closeModal();
            
            setTimeout(() => {
                showQuickPaymentModal();
                document.getElementById('paymentMemberSelect').value = memberId;
                
                const event = new Event('change');
                document.getElementById('paymentMemberSelect').dispatchEvent(event);
            }, 300);
        }

        function generateMemberStatement(memberId) {
            const member = employees.find(emp => emp.id === memberId);
            if (!member) return;
            
            const calculation = calculateMemberCurrentReceivable(member);
            const memberPayments = payments.filter(p => p.employeeId === memberId);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-invoice-dollar text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Member Statement</h3>
                                <p class="opacity-90">${member.name} - ${member.designation}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statement Print Area -->
                    <div id="statementPrintArea" class="receipt-container bg-white p-8 rounded-lg border-2 border-gray-300">
                        <div class="watermark">STATEMENT</div>
                        
                        <div class="receipt-header">
                            <h2 class="text-3xl font-bold">${CONFIG.SOCIETY_NAME}</h2>
                            <p class="text-lg">${CONFIG.SOCIETY_ADDRESS}</p>
                            <p class="text-lg">Member Account Statement</p>
                            <div class="border-t-2 border-black my-4 pt-2">
                                <h3 class="text-2xl font-bold">MEMBER STATEMENT</h3>
                                <p class="text-lg">As on ${new Date().toLocaleDateString('en-IN')}</p>
                            </div>
                        </div>
                        
                        <table class="receipt-table">
                            <tr>
                                <th colspan="2" class="text-center bg-gray-100">Member Information</th>
                            </tr>
                            <tr>
                                <td class="font-bold">Member ID:</td>
                                <td>${member.id}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Name:</td>
                                <td>${member.name}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Designation:</td>
                                <td>${member.designation}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Joining Date:</td>
                                <td>${formatDate(member.joinDate)}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Months Since Joining:</td>
                                <td>${calculation.totalMonthsDue} months</td>
                            </tr>
                        </table>
                        
                        <table class="receipt-table mt-4">
                            <tr>
                                <th colspan="2" class="text-center bg-gray-100">Financial Summary</th>
                            </tr>
                            <tr>
                                <td class="font-bold">Monthly Contribution:</td>
                                <td>${formatCurrency(CONFIG.MONTHLY_CONTRIBUTION)}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Total Receivable:</td>
                                <td>${formatCurrency(calculation.totalReceivableFromJoining)}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Total Paid:</td>
                                <td class="amount-paid">${formatCurrency(calculation.totalReceived)}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Total Pending:</td>
                                <td class="amount-pending">${formatCurrency(calculation.totalPending)}</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Current Due:</td>
                                <td class="${calculation.currentReceivable > 0 ? 'amount-pending' : 'amount-paid'}">
                                    ${formatCurrency(calculation.currentReceivable)}
                                </td>
                            </tr>
                            <tr>
                                <td class="font-bold">Payment Status:</td>
                                <td class="${calculation.currentReceivable > 0 ? 'amount-pending' : 'amount-paid'}">
                                    ${calculation.currentReceivable > 0 ? 'Pending' : 'Up to Date'}
                                </td>
                            </tr>
                        </table>
                        
                        ${memberPayments.length > 0 ? `
                        <div class="mt-6">
                            <h4 class="text-xl font-bold border-b pb-2 mb-4">Payment History</h4>
                            <table class="receipt-table">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-2 px-4 text-left">Date</th>
                                        <th class="py-2 px-4 text-left">Receipt No</th>
                                        <th class="py-2 px-4 text-left">Amount</th>
                                        <th class="py-2 px-4 text-left">Mode</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${memberPayments.map(payment => `
                                        <tr class="border-b">
                                            <td class="py-2 px-4">${formatDate(payment.date)}</td>
                                            <td class="py-2 px-4">${payment.receiptNo}</td>
                                            <td class="py-2 px-4 font-semibold">${formatCurrency(payment.amount)}</td>
                                            <td class="py-2 px-4">${payment.mode}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                        
                        <div class="receipt-footer mt-8">
                            <div class="text-center">
                                <p class="font-bold">Authorized Signature</p>
                                <div class="receipt-stamp" style="transform: rotate(0); margin: 20px auto;">
                                    ${CONFIG.SOCIETY_SEAL}
                                </div>
                            </div>
                            
                            <p class="text-sm text-center text-gray-600 mt-6">
                                <strong>Note:</strong> This is a computer generated statement.
                            </p>
                            <p class="text-sm text-center text-gray-600">
                                Generated on: ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN')}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                        <button onclick="printStatement()" class="download-btn">
                            <i class="fas fa-print"></i> Print Statement
                        </button>
                        
                        <button onclick="downloadStatementAsPDF('${member.name}')" class="download-btn" style="background-color: #3b82f6;">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Member Statement', html);
        }

        function printStatement() {
            const printContent = document.getElementById('statementPrintArea').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            loadMainApplication();
        }

        function downloadStatementAsPDF(memberName) {
            const element = document.getElementById('statementPrintArea');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 190;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`Statement_${memberName}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                showToast('Success', 'Statement downloaded as PDF', 'success');
            }).catch(error => {
                console.error('PDF generation error:', error);
                showToast('Error', 'Failed to generate PDF', 'error');
            });
        }

        // ====================
        // OTHER FUNCTIONS
        // ====================
        function showAllMembersView() {
            const activeMembers = employees.filter(emp => !emp.deleted);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-users text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">All Members</h3>
                                <p class="opacity-90">Total: ${activeMembers.length} Members</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <input type="text" id="memberSearch" class="p-2 border border-gray-300 rounded-lg" placeholder="Search by name..." onkeyup="filterMembersTable()">
                            <button onclick="filterMembersTable()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <button onclick="exportMembersToExcel()" class="excel-export-btn">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-3 px-4 text-left">ID</th>
                                    <th class="py-3 px-4 text-left">Name</th>
                                    <th class="py-3 px-4 text-left">Designation</th>
                                    <th class="py-3 px-4 text-left">Phone</th>
                                    <th class="py-3 px-4 text-left">Status</th>
                                    <th class="py-3 px-4 text-left">Total Paid</th>
                                    <th class="py-3 px-4 text-left">Current Due</th>
                                    <th class="py-3 px-4 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                ${activeMembers.map(member => {
                                    const calculation = calculateMemberCurrentReceivable(member);
                                    
                                    let statusBadge = '';
                                    if (member.status === 'retired') {
                                        statusBadge = '<span class="status-badge status-retired">Retired</span>';
                                    } else if (member.parked) {
                                        statusBadge = '<span class="status-badge status-parked">Parked</span>';
                                    } else if (member.transferred) {
                                        statusBadge = '<span class="status-badge status-transferred">Transferred</span>';
                                    } else if (member.deleted) {
                                        statusBadge = '<span class="status-badge status-deleted">Deleted</span>';
                                    } else {
                                        statusBadge = '<span class="status-badge status-active">Active</span>';
                                    }
                                    
                                    return `
                                        <tr class="border-b hover:bg-gray-50" data-name="${member.name.toLowerCase()}">
                                            <td class="py-3 px-4">${member.id}</td>
                                            <td class="py-3 px-4 font-semibold">${member.name}</td>
                                            <td class="py-3 px-4">${member.designation}</td>
                                            <td class="py-3 px-4">${member.phone || '-'}</td>
                                            <td class="py-3 px-4">${statusBadge}</td>
                                            <td class="py-3 px-4 font-semibold text-green-600">
                                                ${formatCurrency(calculation.totalReceived)}
                                            </td>
                                            <td class="py-3 px-4 font-semibold ${calculation.currentReceivable > 0 ? 'text-red-600' : 'text-green-600'}">
                                                ${formatCurrency(calculation.currentReceivable)}
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="action-buttons">
                                                    <button onclick="viewMemberDetails(${member.id})" class="action-btn edit-btn">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                    ${currentUserRole === USER_ROLES.ADMIN ? `
                                                    <button onclick="addPaymentForMember(${member.id})" class="action-btn" style="background-color: #10b981; color: white;">
                                                        <i class="fas fa-money-bill-wave"></i> Pay
                                                    </button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Showing ${activeMembers.length} members
                        </div>
                        <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('All Members', html);
        }

        function filterMembersTable() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#membersTableBody tr');
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                if (name.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showPendingPayments() {
            const activeMembers = employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired' && !emp.transferred);
            const pendingMembers = [];
            
            activeMembers.forEach(member => {
                const calculation = calculateMemberCurrentReceivable(member);
                
                if (calculation.currentReceivable > 0) {
                    pendingMembers.push({
                        member,
                        calculation
                    });
                }
            });
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Pending Payments</h3>
                                <p class="opacity-90">Total: ${pendingMembers.length} Members</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-yellow-800">Total Pending Amount</h4>
                                <p class="text-2xl font-bold text-yellow-700 mt-2">
                                    ${formatCurrency(pendingMembers.reduce((sum, item) => sum + item.calculation.currentReceivable, 0))}
                                </p>
                            </div>
                            <button onclick="sendRemindersToAll()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">
                                <i class="fas fa-bell mr-2"></i>Send Reminders
                            </button>
                        </div>
                    </div>
                    
                    ${pendingMembers.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-3 px-4 text-left">ID</th>
                                        <th class="py-3 px-4 text-left">Name</th>
                                        <th class="py-3 px-4 text-left">Designation</th>
                                        <th class="py-3 px-4 text-left">Phone</th>
                                        <th class="py-3 px-4 text-left">Total Due</th>
                                        <th class="py-3 px-4 text-left">Paid</th>
                                        <th class="py-3 px-4 text-left">Pending</th>
                                        <th class="py-3 px-4 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingMembers.map(item => {
                                        const { member, calculation } = item;
                                        return `
                                            <tr class="border-b hover:bg-red-50">
                                                <td class="py-3 px-4">${member.id}</td>
                                                <td class="py-3 px-4 font-semibold">${member.name}</td>
                                                <td class="py-3 px-4">${member.designation}</td>
                                                <td class="py-3 px-4">${member.phone || '-'}</td>
                                                <td class="py-3 px-4">${formatCurrency(calculation.totalReceivableFromJoining)}</td>
                                                <td class="py-3 px-4 text-green-600 font-semibold">${formatCurrency(calculation.totalReceived)}</td>
                                                <td class="py-3 px-4 text-red-600 font-semibold">${formatCurrency(calculation.currentReceivable)}</td>
                                                <td class="py-3 px-4">
                                                    <div class="action-buttons">
                                                        <button onclick="addPaymentForMember(${member.id})" class="action-btn" style="background-color: #10b981; color: white;">
                                                            <i class="fas fa-money-bill-wave"></i>
                                                        </button>
                                                        ${member.phone ? `
                                                        <button onclick="sendReminder(${member.id})" class="action-btn" style="background-color: #25D366; color: white;">
                                                            <i class="fab fa-whatsapp"></i>
                                                        </button>
                                                        ` : ''}
                                                        <button onclick="viewMemberDetails(${member.id})" class="action-btn edit-btn">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <i class="fas fa-check-circle text-4xl text-green-400 mb-4"></i>
                            <h4 class="text-xl font-bold text-gray-700">All Payments Received!</h4>
                            <p class="text-gray-600">No pending payments for current month.</p>
                        </div>
                    `}
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Pending Payments', html);
        }

        // ====================
        // PASSWORD MANAGEMENT
        // ====================
        function loadPasswords() {
            const savedPasswords = localStorage.getItem(CONFIG.PASSWORDS_KEY);
            if (savedPasswords) {
                try {
                    passwords = JSON.parse(savedPasswords);
                } catch (e) {
                    passwords = { ...DEFAULT_PASSWORDS };
                }
            }
        }

        // ====================
        // LOGIN SYSTEM
        // ====================
        function showLoginScreen() {
            const loginHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div class="glass-card rounded-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-lock text-white text-3xl"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800">DGST Welfare Society</h1>
                            <p class="text-gray-600 mt-2">120 Members System v3.8</p>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Select Role</label>
                                <select id="loginRole" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                    <option value="">-- Select Your Role --</option>
                                    <option value="${USER_ROLES.ADMIN}">Administrator (Full Access)</option>
                                    <option value="${USER_ROLES.VIEWER}">Viewer (Read Only)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                <div class="flex gap-2">
                                    <input type="password" id="loginPassword" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter password">
                                    <button onclick="toggleLoginPassword()" class="px-4 border-2 border-gray-300 rounded-lg">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span id="errorMessage">Invalid credentials</span>
                            </div>
                            
                            <button onclick="attemptLogin()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700">
                                <i class="fas fa-sign-in-alt mr-2"></i>Login to System
                            </button>
                        </div>
                        
                        <div class="mt-8 text-center text-sm text-gray-500">
                            <p><i class="fas fa-receipt mr-2"></i>Enhanced Receipt System v3.8</p>
                            <p class="mt-1">DGST Welfare Society - 120 Members System</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('loginScreen').innerHTML = loginHTML;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function toggleLoginPassword() {
            const input = document.getElementById('loginPassword');
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        function attemptLogin() {
            const role = document.getElementById('loginRole').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!role || !password) {
                showLoginError('Please select role and enter password');
                return;
            }
            
            if (passwords[role] && passwords[role] === password) {
                currentUserRole = role;
                currentUser = role.charAt(0).toUpperCase() + role.slice(1);
                
                sessionStorage.setItem('dgst_logged_in', 'true');
                sessionStorage.setItem('dgst_user_role', role);
                sessionStorage.setItem('dgst_user', currentUser);
                
                loadMainApplication();
            } else {
                showLoginError('Invalid password for selected role');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            errorDiv.classList.add('shake');
            
            setTimeout(() => {
                errorDiv.classList.remove('shake');
            }, 500);
        }

        function loadMainApplication() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            setupRoleBasedAccess();
            initializeApp();
        }

        // ====================
        // ROLE-BASED ACCESS CONTROL
        // ====================
        function setupRoleBasedAccess() {
            document.getElementById('userRole').textContent = currentUser;
            document.getElementById('userRoleText').textContent = currentUser;
            document.getElementById('dropdownUserName').textContent = currentUser + ' User';
            
            const adminOnlyBtns = document.querySelectorAll('.quick-payment-btn, .add-member-btn, .edit-members-btn, .withdrawal-btn, .reset-btn');
            const settingsBtn = document.getElementById('settingsBtn');
            
            if (currentUserRole === USER_ROLES.VIEWER) {
                adminOnlyBtns.forEach(btn => btn.style.display = 'none');
                if (settingsBtn) settingsBtn.style.display = 'none';
            }
        }

        // ====================
        // INITIALIZATION
        // ====================
        async function initializeApp() {
            loadPasswords();
            await loadData();

            // Setup Firebase real-time sync if enabled
            setupFirebaseSync();

            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');

            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });

                document.addEventListener('click', function(e) {
                    if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }

            updateDateTime();
            setInterval(updateDateTime, 60000);
        }

        // Setup Firebase real-time sync listener
        function setupFirebaseSync() {
            if (window.firebaseEnabled && window.setupFirebaseListener) {
                // Show that Firebase is enabled
                showFirebaseSyncStatus(true);

                // Setup real-time listener for data changes from other devices
                window.setupFirebaseListener(CONFIG.DATA_KEY, (data) => {
                    if (data && data.lastSynced) {
                        const localData = localStorage.getItem(CONFIG.DATA_KEY);
                        const localLastUpdated = localData ? JSON.parse(localData).lastUpdated : null;

                        // Only update if Firebase data is newer
                        if (!localLastUpdated || new Date(data.lastSynced) > new Date(localLastUpdated)) {
                            employees = data.employees || DEFAULT_EMPLOYEES;
                            payments = data.payments || [];
                            withdrawals = data.withdrawals || [];
                            activities = data.activities || [];
                            receiptCounter = data.receiptCounter || 1000;
                            withdrawalReceiptCounter = data.withdrawalReceiptCounter || 2000;

                            // Update localStorage
                            localStorage.setItem(CONFIG.DATA_KEY, JSON.stringify(data));

                            // Refresh the dashboard
                            updateDashboard();
                            console.log('Data updated from Firebase real-time sync');
                        }
                    }
                });
            } else {
                // Show offline/not configured status
                const statusEl = document.getElementById('firebaseSyncStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<i class="fas fa-database text-gray-400 mr-1"></i><span class="text-gray-300 text-xs">Local</span>';
                }
            }
        }

        function updateDateTime() {
            const now = new Date();
            const dateTimeStr = now.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' | ' + now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            document.getElementById('currentDateTime').textContent = dateTimeStr;
        }

        // ====================
        // MAIN INITIALIZATION
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = sessionStorage.getItem('dgst_logged_in');
            const savedRole = sessionStorage.getItem('dgst_user_role');
            const savedUser = sessionStorage.getItem('dgst_user');
            
            if (isLoggedIn === 'true' && savedRole && savedUser) {
                currentUserRole = savedRole;
                currentUser = savedUser;
                loadMainApplication();
            } else {
                showLoginScreen();
            }
        });

        // ====================
        // GLOBAL FUNCTIONS
        // ====================
        window.logout = function() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('dgst_logged_in');
                sessionStorage.removeItem('dgst_user_role');
                sessionStorage.removeItem('dgst_user');
                
                showLoginScreen();
            }
        };

        // Export all essential functions to window
        window.showQuickPaymentModal = showQuickPaymentModal;
        window.showAddMemberModal = function() {
            if (currentUserRole === USER_ROLES.VIEWER) {
                showToast('Access Denied', 'Viewer cannot add members', 'error');
                return;
            }
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-plus text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Add New Member</h3>
                                <p class="opacity-90">Register new society member</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="memberName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter full name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Designation *</label>
                            <select id="memberDesignation" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">-- Select Designation --</option>
                                <option value="Assistant">Assistant</option>
                                <option value="Clerk">Clerk</option>
                                <option value="Accountant">Accountant</option>
                                <option value="Peon">Peon</option>
                                <option value="Driver">Driver</option>
                                <option value="DEO">DEO</option>
                                <option value="Steno Typist">Steno Typist</option>
                                <option value="Superintendent">Superintendent</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                            <input type="text" id="memberPhone" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="10-digit mobile number">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Joining Date *</label>
                            <input type="date" id="memberJoinDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Retirement Date</label>
                            <input type="date" id="memberRetirementDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="processAddMember()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Save Member
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Add Member', html);
        };

        window.processAddMember = function() {
            const name = document.getElementById('memberName').value.trim();
            const designation = document.getElementById('memberDesignation').value;
            const phone = document.getElementById('memberPhone').value.trim();
            const joinDate = document.getElementById('memberJoinDate').value;
            const retirementDate = document.getElementById('memberRetirementDate').value;
            
            if (!name || !designation || !joinDate) {
                showToast('Error', 'Please fill all required fields', 'error');
                return;
            }
            
            const newId = employees.length > 0 ? Math.max(...employees.map(emp => emp.id)) + 1 : 1;
            
            const newMember = {
                id: newId,
                name: name,
                designation: designation,
                phone: phone,
                joinDate: joinDate,
                retirementDate: retirementDate || '',
                monthlyReceivable: CONFIG.MONTHLY_CONTRIBUTION,
                totalReceived: 0,
                currentMonthReceivable: CONFIG.MONTHLY_CONTRIBUTION,
                lastUpdatedMonth: getCurrentMonthYear(),
                deleted: false,
                parked: false,
                status: 'active',
                transferred: false,
                transferDate: ''
            };
            
            employees.push(newMember);
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Added new member: ${name} (${designation})`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            
            showToast('Success', `Member ${name} added successfully`, 'success');
        };

        window.showAllMembersView = showAllMembersView;
        window.showPaymentReports = function() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-invoice-dollar text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Payment Reports</h3>
                                <p class="opacity-90">Total Payments: ${payments.length}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <input type="date" id="paymentDateFrom" class="p-2 border border-gray-300 rounded-lg">
                            <span class="self-center">to</span>
                            <input type="date" id="paymentDateTo" class="p-2 border border-gray-300 rounded-lg" value="${new Date().toISOString().split('T')[0]}">
                            <button onclick="filterPayments()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                        <button onclick="exportPaymentsToExcel()" class="excel-export-btn">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-3 px-4 text-left">Date</th>
                                    <th class="py-3 px-4 text-left">Member</th>
                                    <th class="py-3 px-4 text-left">Receipt No</th>
                                    <th class="py-3 px-4 text-left">Amount</th>
                                    <th class="py-3 px-4 text-left">Mode</th>
                                    <th class="py-3 px-4 text-left">Added By</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                ${payments.slice().reverse().map(payment => {
                                    const member = employees.find(emp => emp.id === payment.employeeId);
                                    return `
                                        <tr class="border-b hover:bg-gray-50" data-date="${payment.date}">
                                            <td class="py-3 px-4">${formatDate(payment.date)}</td>
                                            <td class="py-3 px-4 font-semibold">${member ? member.name : payment.employeeName}</td>
                                            <td class="py-3 px-4">${payment.receiptNo}</td>
                                            <td class="py-3 px-4 font-semibold text-green-700">${formatCurrency(payment.amount)}</td>
                                            <td class="py-3 px-4">${payment.mode}</td>
                                            <td class="py-3 px-4">${payment.addedBy || 'System'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Total Amount: ${formatCurrency(payments.reduce((sum, p) => sum + p.amount, 0))}
                        </div>
                        <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Payment Reports', html);
        };

        window.exportDataForEmail = function() {
            const data = {
                members: employees.filter(emp => !emp.deleted),
                payments: payments,
                withdrawals: withdrawals,
                activities: activities.slice(-50),
                settings: {
                    receiptCounter,
                    withdrawalReceiptCounter,
                    version: CONFIG.VERSION,
                    lastUpdated: new Date().toISOString(),
                    totalMembers: employees.filter(emp => !emp.deleted).length,
                    currentBalance: calculateCurrentBalance()
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DGST_Welfare_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Success', 'Data backup downloaded', 'success');
        };

        window.showWelfareSchemes = function() {
            const schemes = CONFIG.WELFARE_SCHEMES;
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-hand-holding-heart text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">सदस्य कल्याण योजनाएं</h3>
                                <p class="opacity-90">DGST Welfare Society Benefits</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        ${Object.values(schemes).map(scheme => `
                            <div class="border border-gray-200 rounded-xl p-6 hover:bg-gray-50">
                                <div class="flex items-start gap-4">
                                    <div class="w-14 h-14 ${scheme.icon.includes('male') ? 'bg-blue-100' : scheme.icon.includes('female') ? 'bg-pink-100' : 'bg-green-100'} rounded-full flex items-center justify-center">
                                        <i class="fas ${scheme.icon} ${scheme.icon.includes('male') ? 'text-blue-600' : scheme.icon.includes('female') ? 'text-pink-600' : 'text-green-600'} text-xl"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-800 text-lg">${scheme.name}</h4>
                                        <p class="text-gray-600 mt-2">${scheme.description}</p>
                                        ${scheme.amount ? `
                                            <div class="mt-3">
                                                <span class="px-3 py-1 bg-green-100 text-green-800 font-semibold rounded-lg">
                                                    Amount: ${formatCurrency(scheme.amount)}
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <h4 class="font-bold text-yellow-800 mb-3 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Important Note
                        </h4>
                        <p class="text-yellow-700">
                            कल्याणकारी योजनाओं का लाभ प्राप्त करने के लिए सदस्य का नियमित मासिक अंशदान अनिवार्य है। बिना अंशदान वाले सदस्यों को योजनाओं का लाभ नहीं मिलेगा।
                        </p>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Welfare Schemes', html);
        };

        window.showTransferredMembers = function() {
            const transferredMembers = employees.filter(emp => emp.transferred && !emp.deleted);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-exchange-alt text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Transferred Members</h3>
                                <p class="opacity-90">स्थानांतरित सदस्य: ${transferredMembers.length}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${transferredMembers.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-3 px-4 text-left">ID</th>
                                        <th class="py-3 px-4 text-left">Name</th>
                                        <th class="py-3 px-4 text-left">Designation</th>
                                        <th class="py-3 px-4 text-left">Transfer Date</th>
                                        <th class="py-3 px-4 text-left">Total Paid</th>
                                        <th class="py-3 px-4 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transferredMembers.map(member => {
                                        const calculation = calculateMemberCurrentReceivable(member);
                                        
                                        return `
                                            <tr class="border-b hover:bg-purple-50">
                                                <td class="py-3 px-4">${member.id}</td>
                                                <td class="py-3 px-4 font-semibold">${member.name}</td>
                                                <td class="py-3 px-4">${member.designation}</td>
                                                <td class="py-3 px-4">${member.transferDate ? formatDate(member.transferDate) : '-'}</td>
                                                <td class="py-3 px-4 font-semibold">${formatCurrency(calculation.totalReceived)}</td>
                                                <td class="py-3 px-4">
                                                    <div class="action-buttons">
                                                        <button onclick="viewMemberDetails(${member.id})" class="action-btn edit-btn">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <i class="fas fa-exchange-alt text-4xl text-purple-400 mb-4"></i>
                            <h4 class="text-xl font-bold text-gray-700">No Transferred Members</h4>
                            <p class="text-gray-600">No members have been transferred yet.</p>
                        </div>
                    `}
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Transferred Members', html);
        };

        window.showEditMembersModal = function() {
            if (currentUserRole === USER_ROLES.VIEWER) {
                showToast('Access Denied', 'Viewer cannot edit members', 'error');
                return;
            }
            
            const activeMembers = employees.filter(emp => !emp.deleted);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-edit text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Edit Members</h3>
                                <p class="opacity-90">Total: ${activeMembers.length} Members</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <input type="text" id="editMemberSearch" class="p-2 border border-gray-300 rounded-lg" placeholder="Search by name..." onkeyup="filterEditMembersTable()">
                            <button onclick="filterEditMembersTable()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-3 px-4 text-left">ID</th>
                                    <th class="py-3 px-4 text-left">Name</th>
                                    <th class="py-3 px-4 text-left">Designation</th>
                                    <th class="py-3 px-4 text-left">Phone</th>
                                    <th class="py-3 px-4 text-left">Status</th>
                                    <th class="py-3 px-4 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="editMembersTableBody">
                                ${activeMembers.map(member => {
                                    let statusBadge = '';
                                    if (member.status === 'retired') {
                                        statusBadge = '<span class="status-badge status-retired">Retired</span>';
                                    } else if (member.parked) {
                                        statusBadge = '<span class="status-badge status-parked">Parked</span>';
                                    } else if (member.transferred) {
                                        statusBadge = '<span class="status-badge status-transferred">Transferred</span>';
                                    } else if (member.deleted) {
                                        statusBadge = '<span class="status-badge status-deleted">Deleted</span>';
                                    } else {
                                        statusBadge = '<span class="status-badge status-active">Active</span>';
                                    }
                                    
                                    return `
                                        <tr class="border-b hover:bg-gray-50" data-name="${member.name.toLowerCase()}">
                                            <td class="py-3 px-4">${member.id}</td>
                                            <td class="py-3 px-4 font-semibold">${member.name}</td>
                                            <td class="py-3 px-4">${member.designation}</td>
                                            <td class="py-3 px-4">${member.phone || '-'}</td>
                                            <td class="py-3 px-4">${statusBadge}</td>
                                            <td class="py-3 px-4">
                                                <div class="action-buttons">
                                                    <button onclick="editMember(${member.id})" class="action-btn edit-btn" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="parkMember(${member.id})" class="action-btn park-btn" title="Park">
                                                        <i class="fas fa-parking"></i>
                                                    </button>
                                                    <button onclick="retireMember(${member.id})" class="action-btn retire-btn" title="Retire">
                                                        <i class="fas fa-user-clock"></i>
                                                    </button>
                                                    <button onclick="transferMember(${member.id})" class="action-btn transfer-btn" title="Transfer">
                                                        <i class="fas fa-exchange-alt"></i>
                                                    </button>
                                                    <button onclick="deleteMember(${member.id})" class="action-btn delete-btn" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Showing ${activeMembers.length} members
                        </div>
                        <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Edit Members', html);
        };

        window.filterEditMembersTable = function() {
            const searchTerm = document.getElementById('editMemberSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#editMembersTableBody tr');
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                if (name.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        window.editMember = function(memberId) {
            const member = employees.find(emp => emp.id === memberId);
            if (!member) return;
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-edit text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Edit Member</h3>
                                <p class="opacity-90">${member.name} - ${member.designation}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="editMemberName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${member.name}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Designation *</label>
                            <input type="text" id="editMemberDesignation" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${member.designation}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                            <input type="text" id="editMemberPhone" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${member.phone || ''}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Joining Date *</label>
                            <input type="date" id="editMemberJoinDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${member.joinDate}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Retirement Date</label>
                            <input type="date" id="editMemberRetirementDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${member.retirementDate || ''}">
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">Financial Information (Auto-calculated)</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Monthly Contribution:</span>
                                <span class="font-semibold">${formatCurrency(CONFIG.MONTHLY_CONTRIBUTION)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Received:</span>
                                <span class="font-semibold">${formatCurrency(member.totalReceived || 0)}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Financial calculations are automatically updated based on payment history.</p>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="saveMemberChanges(${memberId})" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Edit Member', html);
        };

        window.saveMemberChanges = function(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            const member = employees[memberIndex];
            
            employees[memberIndex] = {
                ...member,
                name: document.getElementById('editMemberName').value.trim(),
                designation: document.getElementById('editMemberDesignation').value.trim(),
                phone: document.getElementById('editMemberPhone').value.trim(),
                joinDate: document.getElementById('editMemberJoinDate').value,
                retirementDate: document.getElementById('editMemberRetirementDate').value || ''
            };
            
            const calculation = calculateMemberCurrentReceivable(employees[memberIndex]);
            employees[memberIndex].currentMonthReceivable = calculation.currentReceivable;
            employees[memberIndex].totalReceived = calculation.totalReceived;
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Updated member details: ${member.name}`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            
            showToast('Success', 'Member updated successfully', 'success');
        };

        window.parkMember = function(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            const member = employees[memberIndex];
            
            employees[memberIndex] = {
                ...member,
                parked: true,
                status: 'active',
                transferred: false,
                deleted: false
            };
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Parked member: ${member.name}`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            showEditMembersModal();
            
            showToast('Success', `Member ${member.name} parked successfully`, 'success');
        };

        window.retireMember = function(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            const member = employees[memberIndex];
            
            employees[memberIndex] = {
                ...member,
                status: 'retired',
                parked: false,
                transferred: false,
                deleted: false,
                retirementDate: member.retirementDate || new Date().toISOString().split('T')[0]
            };
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Retired member: ${member.name}`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            showEditMembersModal();
            
            showToast('Success', `Member ${member.name} retired successfully`, 'success');
        };

        window.transferMember = function(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            const member = employees[memberIndex];
            
            employees[memberIndex] = {
                ...member,
                transferred: true,
                transferDate: new Date().toISOString().split('T')[0],
                parked: false,
                deleted: false,
                status: 'active'
            };
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Transferred member: ${member.name}`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            showEditMembersModal();
            
            showToast('Success', `Member ${member.name} transferred successfully`, 'success');
        };

        window.deleteMember = function(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            const member = employees[memberIndex];
            
            employees[memberIndex] = {
                ...member,
                deleted: true,
                parked: false,
                transferred: false,
                status: 'active'
            };
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Deleted member: ${member.name}`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            showEditMembersModal();
            
            showToast('Success', `Member ${member.name} deleted successfully`, 'success');
        };

        window.showPendingPayments = showPendingPayments;
        window.showExcelExportOptions = function() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-500 to-teal-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-excel text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Excel Data Export</h3>
                                <p class="opacity-90">Export system data to Excel format</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:bg-blue-50" onclick="exportMembersToExcel()">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-users text-blue-600 text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-gray-800">Members Data</h4>
                            <p class="text-sm text-gray-600 mt-2">Export all members with financial details</p>
                        </div>
                        
                        <div class="border border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:bg-green-50" onclick="exportPaymentsToExcel()">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-money-bill-wave text-green-600 text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-gray-800">Payments Data</h4>
                            <p class="text-sm text-gray-600 mt-2">Export all payment transactions</p>
                        </div>
                        
                        <div class="border border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:bg-red-50" onclick="exportWithdrawalsToExcel()">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-university text-red-600 text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-gray-800">Withdrawals Data</h4>
                            <p class="text-sm text-gray-600 mt-2">Export all withdrawal records</p>
                        </div>
                        
                        <div class="border border-gray-200 rounded-xl p-6 text-center cursor-pointer hover:bg-purple-50" onclick="exportCompleteData()">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-database text-purple-600 text-2xl"></i>
                            </div>
                            <h4 class="font-bold text-gray-800">Complete Data</h4>
                            <p class="text-sm text-gray-600 mt-2">Export all system data in one file</p>
                        </div>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Excel Export Options', html);
        };

        window.exportMembersToExcel = function() {
            const activeMembers = employees.filter(emp => !emp.deleted);
            const data = activeMembers.map(member => {
                const calculation = calculateMemberCurrentReceivable(member);
                
                return {
                    'ID': member.id,
                    'Name': member.name,
                    'Designation': member.designation,
                    'Phone': member.phone || '',
                    'Joining Date': member.joinDate,
                    'Retirement Date': member.retirementDate || '',
                    'Status': member.status,
                    'Parked': member.parked ? 'Yes' : 'No',
                    'Transferred': member.transferred ? 'Yes' : 'No',
                    'Monthly Contribution': CONFIG.MONTHLY_CONTRIBUTION,
                    'Total Receivable': calculation.totalReceivableFromJoining,
                    'Total Paid': calculation.totalReceived,
                    'Total Pending': calculation.totalPending,
                    'Current Due': calculation.currentReceivable,
                    'Months Paid': calculation.monthsPaid,
                    'Total Months': calculation.totalMonthsDue,
                    'Payment Status': calculation.currentReceivable > 0 ? 'Pending' : 'Paid'
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Members');
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DGST_Members_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Success', 'Members exported to Excel', 'success');
        };

        window.exportPaymentsToExcel = function() {
            const data = payments.map(payment => {
                const member = employees.find(emp => emp.id === payment.employeeId);
                return {
                    'Date': payment.date,
                    'Member ID': payment.employeeId,
                    'Member Name': member ? member.name : payment.employeeName,
                    'Receipt No': payment.receiptNo,
                    'Amount': payment.amount,
                    'Payment Mode': payment.mode,
                    'Remarks': payment.remarks || '',
                    'Added By': payment.addedBy || 'System',
                    'Timestamp': payment.timestamp
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Payments');
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DGST_Payments_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Success', 'Payments exported to Excel', 'success');
        };

        window.showParkedMembers = function() {
            const parkedMembers = employees.filter(emp => emp.parked && !emp.deleted);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-gray-500 to-gray-700 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-parking text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Parked Members</h3>
                                <p class="opacity-90">Non-contributing members: ${parkedMembers.length}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${parkedMembers.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-3 px-4 text-left">ID</th>
                                        <th class="py-3 px-4 text-left">Name</th>
                                        <th class="py-3 px-4 text-left">Designation</th>
                                        <th class="py-3 px-4 text-left">Phone</th>
                                        <th class="py-3 px-4 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${parkedMembers.map(member => {
                                        return `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="py-3 px-4">${member.id}</td>
                                                <td class="py-3 px-4 font-semibold">${member.name}</td>
                                                <td class="py-3 px-4">${member.designation}</td>
                                                <td class="py-3 px-4">${member.phone || '-'}</td>
                                                <td class="py-3 px-4">
                                                    <div class="action-buttons">
                                                        ${currentUserRole === USER_ROLES.ADMIN ? `
                                                        <button onclick="unparkMember(${member.id})" class="action-btn restore-btn">
                                                            <i class="fas fa-play"></i> Unpark
                                                        </button>
                                                        ` : ''}
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <i class="fas fa-parking text-4xl text-gray-400 mb-4"></i>
                            <h4 class="text-xl font-bold text-gray-700">No Parked Members</h4>
                            <p class="text-gray-600">All members are currently active contributors.</p>
                        </div>
                    `}
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Parked Members', html);
        };

        window.unparkMember = function(memberId) {
            const memberIndex = employees.findIndex(emp => emp.id === memberId);
            if (memberIndex === -1) return;
            
            employees[memberIndex].parked = false;
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Unparked member: ${employees[memberIndex].name}`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            
            showToast('Success', 'Member unparked successfully', 'success');
        };

        window.showRetiredMembersDetails = function() {
            const retiredMembers = employees.filter(emp => emp.status === 'retired' && !emp.deleted);
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-clock text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Retired Members</h3>
                                <p class="opacity-90">Total: ${retiredMembers.length} Members</p>
                            </div>
                        </div>
                    </div>
                    
                    ${retiredMembers.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-3 px-4 text-left">ID</th>
                                        <th class="py-3 px-4 text-left">Name</th>
                                        <th class="py-3 px-4 text-left">Designation</th>
                                        <th class="py-3 px-4 text-left">Retirement Date</th>
                                        <th class="py-3 px-4 text-left">Total Paid</th>
                                        <th class="py-3 px-4 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${retiredMembers.map(member => {
                                        const calculation = calculateMemberCurrentReceivable(member);
                                        
                                        return `
                                            <tr class="border-b hover:bg-orange-50">
                                                <td class="py-3 px-4">${member.id}</td>
                                                <td class="py-3 px-4 font-semibold">${member.name}</td>
                                                <td class="py-3 px-4">${member.designation}</td>
                                                <td class="py-3 px-4">${member.retirementDate ? formatDate(member.retirementDate) : '-'}</td>
                                                <td class="py-3 px-4 font-semibold">${formatCurrency(calculation.totalReceived)}</td>
                                                <td class="py-3 px-4">
                                                    <div class="action-buttons">
                                                        <button onclick="viewMemberDetails(${member.id})" class="action-btn edit-btn">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <i class="fas fa-user-clock text-4xl text-orange-400 mb-4"></i>
                            <h4 class="text-xl font-bold text-gray-700">No Retired Members</h4>
                            <p class="text-gray-600">No members have retired yet.</p>
                        </div>
                    `}
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Retired Members', html);
        };

        window.showMainAccountWithdrawalModal = function() {
            if (currentUserRole === USER_ROLES.VIEWER) {
                showToast('Access Denied', 'Viewer cannot make withdrawals', 'error');
                return;
            }
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-university text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Main Account Withdrawal</h3>
                                <p class="opacity-90">Society account से निकासी</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Withdrawal Amount (₹)</label>
                            <input type="number" id="withdrawalAmount" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter amount" min="1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Withdrawal Date</label>
                            <input type="date" id="withdrawalDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                            <select id="withdrawalCategory" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="Welfare Scheme">Welfare Scheme</option>
                                <option value="Society Expense">Society Expense</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Purpose</label>
                            <input type="text" id="withdrawalPurpose" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Enter purpose of withdrawal">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="withdrawalDescription" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" rows="3" placeholder="Detailed description of withdrawal..."></textarea>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-bold text-yellow-800 mb-2">Account Status</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Current Balance:</span>
                                <span class="font-semibold">${formatCurrency(calculateCurrentBalance())}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Withdrawals:</span>
                                <span class="font-semibold">${formatCurrency(withdrawals.reduce((sum, w) => sum + w.amount, 0))}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="processWithdrawal()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700">
                            <i class="fas fa-check-circle mr-2"></i>Process Withdrawal
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Main Account Withdrawal', html);
        };

        window.processWithdrawal = function() {
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const date = document.getElementById('withdrawalDate').value;
            const category = document.getElementById('withdrawalCategory').value;
            const purpose = document.getElementById('withdrawalPurpose').value.trim();
            const description = document.getElementById('withdrawalDescription').value.trim();
            
            if (!amount || !date || !purpose) {
                showToast('Error', 'Please fill all required fields', 'error');
                return;
            }
            
            if (amount <= 0) {
                showToast('Error', 'Amount must be greater than 0', 'error');
                return;
            }
            
            const currentBalance = calculateCurrentBalance();
            if (amount > currentBalance) {
                showToast('Error', `Insufficient balance! Current balance is ${formatCurrency(currentBalance)}`, 'error');
                return;
            }
            
            const withdrawal = {
                id: Date.now(),
                amount: amount,
                date: date,
                category: category,
                purpose: purpose,
                description: description,
                receiptNo: `WTH${withdrawalReceiptCounter++}`,
                timestamp: new Date().toISOString(),
                addedBy: currentUser,
                monthYear: getCurrentMonthYear()
            };
            
            withdrawals.push(withdrawal);
            
            activities.push({
                id: Date.now(),
                user: currentUser,
                action: `Processed withdrawal of ${formatCurrency(amount)} for ${purpose} (Receipt: ${withdrawal.receiptNo})`,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateDashboard();
            closeModal();
            
            showToast('Success', `Withdrawal of ${formatCurrency(amount)} processed successfully`, 'success');
        };

        window.showWithdrawalReports = function() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-invoice text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Withdrawal Reports</h3>
                                <p class="opacity-90">Total Withdrawals: ${withdrawals.length}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex gap-2">
                            <input type="date" id="withdrawalDateFrom" class="p-2 border border-gray-300 rounded-lg">
                            <span class="self-center">to</span>
                            <input type="date" id="withdrawalDateTo" class="p-2 border border-gray-300 rounded-lg" value="${new Date().toISOString().split('T')[0]}">
                            <button onclick="filterWithdrawals()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                        <button onclick="exportWithdrawalsToExcel()" class="excel-export-btn">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-3 px-4 text-left">Date</th>
                                    <th class="py-3 px-4 text-left">Receipt No</th>
                                    <th class="py-3 px-4 text-left">Amount</th>
                                    <th class="py-3 px-4 text-left">Category</th>
                                    <th class="py-3 px-4 text-left">Purpose</th>
                                    <th class="py-3 px-4 text-left">Added By</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawalsTableBody">
                                ${withdrawals.slice().reverse().map(withdrawal => `
                                    <tr class="border-b hover:bg-red-50" data-date="${withdrawal.date}">
                                        <td class="py-3 px-4">${formatDate(withdrawal.date)}</td>
                                        <td class="py-3 px-4">${withdrawal.receiptNo}</td>
                                        <td class="py-3 px-4 font-semibold text-red-700">${formatCurrency(withdrawal.amount)}</td>
                                        <td class="py-3 px-4">${withdrawal.category}</td>
                                        <td class="py-3 px-4">${withdrawal.purpose}</td>
                                        <td class="py-3 px-4">${withdrawal.addedBy || 'System'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Total Amount: ${formatCurrency(withdrawals.reduce((sum, w) => sum + w.amount, 0))}
                        </div>
                        <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal('Withdrawal Reports', html);
        };

        window.exportWithdrawalsToExcel = function() {
            const data = withdrawals.map(withdrawal => {
                return {
                    'Date': withdrawal.date,
                    'Receipt No': withdrawal.receiptNo,
                    'Amount': withdrawal.amount,
                    'Category': withdrawal.category,
                    'Purpose': withdrawal.purpose,
                    'Description': withdrawal.description || '',
                    'Added By': withdrawal.addedBy || 'System',
                    'Timestamp': withdrawal.timestamp
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Withdrawals');
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DGST_Withdrawals_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Success', 'Withdrawals exported to Excel', 'success');
        };

        window.exportCompleteData = function() {
            // Create multiple sheets in one Excel file
            const wb = XLSX.utils.book_new();
            
            // Members sheet
            const membersData = employees.filter(emp => !emp.deleted).map(member => {
                const calculation = calculateMemberCurrentReceivable(member);
                
                return {
                    'ID': member.id,
                    'Name': member.name,
                    'Designation': member.designation,
                    'Phone': member.phone || '',
                    'Joining Date': member.joinDate,
                    'Retirement Date': member.retirementDate || '',
                    'Status': member.status,
                    'Parked': member.parked ? 'Yes' : 'No',
                    'Transferred': member.transferred ? 'Yes' : 'No',
                    'Monthly Contribution': CONFIG.MONTHLY_CONTRIBUTION,
                    'Total Receivable': calculation.totalReceivableFromJoining,
                    'Total Paid': calculation.totalReceived,
                    'Total Pending': calculation.totalPending,
                    'Current Due': calculation.currentReceivable,
                    'Months Paid': calculation.monthsPaid,
                    'Total Months': calculation.totalMonthsDue
                };
            });
            
            const membersWs = XLSX.utils.json_to_sheet(membersData);
            XLSX.utils.book_append_sheet(wb, membersWs, 'Members');
            
            // Payments sheet
            const paymentsData = payments.map(payment => {
                const member = employees.find(emp => emp.id === payment.employeeId);
                return {
                    'Date': payment.date,
                    'Member ID': payment.employeeId,
                    'Member Name': member ? member.name : payment.employeeName,
                    'Receipt No': payment.receiptNo,
                    'Amount': payment.amount,
                    'Payment Mode': payment.mode,
                    'Remarks': payment.remarks || '',
                    'Added By': payment.addedBy || 'System'
                };
            });
            
            const paymentsWs = XLSX.utils.json_to_sheet(paymentsData);
            XLSX.utils.book_append_sheet(wb, paymentsWs, 'Payments');
            
            // Withdrawals sheet
            const withdrawalsData = withdrawals.map(withdrawal => {
                return {
                    'Date': withdrawal.date,
                    'Receipt No': withdrawal.receiptNo,
                    'Amount': withdrawal.amount,
                    'Category': withdrawal.category,
                    'Purpose': withdrawal.purpose,
                    'Description': withdrawal.description || '',
                    'Added By': withdrawal.addedBy || 'System'
                };
            });
            
            const withdrawalsWs = XLSX.utils.json_to_sheet(withdrawalsData);
            XLSX.utils.book_append_sheet(wb, withdrawalsWs, 'Withdrawals');
            
            // Summary sheet
            const summaryData = [{
                'Total Members': employees.filter(emp => !emp.deleted).length,
                'Active Members': employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired' && !emp.transferred).length,
                'Retired Members': employees.filter(emp => emp.status === 'retired').length,
                'Parked Members': employees.filter(emp => emp.parked).length,
                'Transferred Members': employees.filter(emp => emp.transferred).length,
                'Total Payments': payments.length,
                'Total Payments Amount': payments.reduce((sum, p) => sum + p.amount, 0),
                'Total Withdrawals': withdrawals.length,
                'Total Withdrawals Amount': withdrawals.reduce((sum, w) => sum + w.amount, 0),
                'Current Balance': calculateCurrentBalance(),
                'Data Exported On': new Date().toISOString(),
                'System Version': CONFIG.VERSION
            }];
            
            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Export the workbook
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DGST_Complete_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast('Success', 'Complete data exported to Excel', 'success');
        };

        window.showRetirementDetails = function(type) {
            let filteredMembers = [];
            let title = '';
            
            if (type === 'active') {
                filteredMembers = employees.filter(emp => !emp.deleted && !emp.parked && emp.status !== 'retired' && !emp.transferred);
                title = 'Active Members';
            } else if (type === 'retiring-soon') {
                const now = new Date();
                const sixMonthsFromNow = new Date();
                sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);
                
                filteredMembers = employees.filter(emp => {
                    if (!emp.retirementDate || emp.deleted || emp.parked || emp.status === 'retired' || emp.transferred) return false;
                    const retirementDate = new Date(emp.retirementDate);
                    return retirementDate <= sixMonthsFromNow && retirementDate > now;
                });
                title = 'Retiring Soon Members';
            } else if (type === 'retired') {
                filteredMembers = employees.filter(emp => emp.status === 'retired' && !emp.deleted);
                title = 'Retired Members';
            }
            
            const targetElement = type === 'retiring-soon' ? 'retiringSoonList' : 'retiredList';
            const detailsElement = type === 'retiring-soon' ? 'retiringSoonDetails' : 'retiredDetails';
            
            let html = '';
            if (filteredMembers.length > 0) {
                filteredMembers.forEach(member => {
                    html += `
                        <div class="flex justify-between items-center p-2 border-b border-gray-200 last:border-b-0">
                            <div>
                                <p class="font-semibold">${member.name}</p>
                                <p class="text-xs text-gray-600">${member.designation}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm ${type === 'retiring-soon' ? 'text-yellow-600' : 'text-red-600'}">
                                    ${member.retirementDate ? formatDate(member.retirementDate) : '-'}
                                </p>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = `<p class="text-center text-gray-500 py-2">No ${title.toLowerCase()}</p>`;
            }
            
            document.getElementById(targetElement).innerHTML = html;
            document.getElementById(detailsElement).classList.toggle('hidden');
        };

        window.showSettingsModal = function() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-cog text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">System Settings</h3>
                                <p class="opacity-90">Manage application preferences</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-gray-200 rounded-xl p-6">
                            <h4 class="font-bold text-gray-800 mb-4">General Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Monthly Contribution (₹)</label>
                                    <input type="number" id="monthlyContribution" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${CONFIG.MONTHLY_CONTRIBUTION}" min="1">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Society Name</label>
                                    <input type="text" id="societyName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${CONFIG.SOCIETY_NAME}">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Society Address</label>
                                    <input type="text" id="societyAddress" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" value="${CONFIG.SOCIETY_ADDRESS}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="border border-gray-200 rounded-xl p-6">
                            <h4 class="font-bold text-gray-800 mb-4">System Information</h4>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">System Version:</span>
                                    <span class="font-semibold">${CONFIG.VERSION}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Members:</span>
                                    <span class="font-semibold">${employees.filter(emp => !emp.deleted).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Payments:</span>
                                    <span class="font-semibold">${payments.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Withdrawals:</span>
                                    <span class="font-semibold">${withdrawals.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Current Balance:</span>
                                    <span class="font-semibold">${formatCurrency(calculateCurrentBalance())}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Firebase Status:</span>
                                    <span class="font-semibold ${window.firebaseEnabled ? 'text-green-600' : 'text-red-600'}">
                                        ${window.firebaseEnabled ? 'Connected' : 'Not Configured'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="saveSettings()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>Save Settings
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
            `;
            
            showModal('System Settings', html);
        };

        window.saveSettings = function() {
            const monthlyContribution = parseInt(document.getElementById('monthlyContribution').value);
            const societyName = document.getElementById('societyName').value.trim();
            const societyAddress = document.getElementById('societyAddress').value.trim();
            
            if (!monthlyContribution || monthlyContribution < 1) {
                showToast('Error', 'Monthly contribution must be at least ₹1', 'error');
                return;
            }
            
            if (!societyName) {
                showToast('Error', 'Society name is required', 'error');
                return;
            }
            
            // Update config values
            CONFIG.MONTHLY_CONTRIBUTION = monthlyContribution;
            CONFIG.SOCIETY_NAME = societyName;
            CONFIG.SOCIETY_ADDRESS = societyAddress;
            
            // Update all members' monthly receivable
            employees.forEach((emp, index) => {
                if (!emp.deleted && !emp.parked && emp.status !== 'retired') {
                    employees[index].monthlyReceivable = monthlyContribution;
                }
            });
            
            saveData();
            updateDashboard();
            closeModal();
            
            showToast('Success', 'Settings saved successfully', 'success');
        };

        window.showChangePasswordModal = function() {
            if (currentUserRole !== USER_ROLES.ADMIN) {
                showToast('Access Denied', 'Only admin can change passwords', 'error');
                return;
            }
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-key text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Change Passwords</h3>
                                <p class="opacity-90">Update system access passwords</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="border border-gray-200 rounded-xl p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Admin Password</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Current Admin Password</label>
                                    <input type="password" id="currentAdminPass" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">New Admin Password</label>
                                    <input type="password" id="newAdminPass" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                </div>
                            </div>
                            <button onclick="changeAdminPassword()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">
                                Change Admin Password
                            </button>
                        </div>
                        
                        <div class="border border-gray-200 rounded-xl p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Viewer Password</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Current Viewer Password</label>
                                    <input type="password" id="currentViewerPass" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">New Viewer Password</label>
                                    <input type="password" id="newViewerPass" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                </div>
                            </div>
                            <button onclick="changeViewerPassword()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">
                                Change Viewer Password
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                        <h4 class="font-bold text-yellow-800 mb-2 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Important Notes
                        </h4>
                        <ul class="text-yellow-700 text-sm space-y-1">
                            <li>• Passwords are case-sensitive</li>
                            <li>• Keep passwords secure and confidential</li>
                            <li>• Changing passwords will not affect currently logged-in users</li>
                            <li>• New passwords will take effect on next login</li>
                        </ul>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('Change Passwords', html);
        };

        window.changeAdminPassword = function() {
            const currentPass = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;
            
            if (!currentPass || !newPass) {
                showToast('Error', 'Please fill both password fields', 'error');
                return;
            }
            
            if (currentPass !== passwords[USER_ROLES.ADMIN]) {
                showToast('Error', 'Current admin password is incorrect', 'error');
                return;
            }
            
            if (newPass.length < 4) {
                showToast('Error', 'New password must be at least 4 characters', 'error');
                return;
            }
            
            passwords[USER_ROLES.ADMIN] = newPass;
            localStorage.setItem(CONFIG.PASSWORDS_KEY, JSON.stringify(passwords));
            
            showToast('Success', 'Admin password changed successfully', 'success');
            document.getElementById('currentAdminPass').value = '';
            document.getElementById('newAdminPass').value = '';
        };

        window.changeViewerPassword = function() {
            const currentPass = document.getElementById('currentViewerPass').value;
            const newPass = document.getElementById('newViewerPass').value;
            
            if (!currentPass || !newPass) {
                showToast('Error', 'Please fill both password fields', 'error');
                return;
            }
            
            if (currentPass !== passwords[USER_ROLES.VIEWER]) {
                showToast('Error', 'Current viewer password is incorrect', 'error');
                return;
            }
            
            if (newPass.length < 4) {
                showToast('Error', 'New password must be at least 4 characters', 'error');
                return;
            }
            
            passwords[USER_ROLES.VIEWER] = newPass;
            localStorage.setItem(CONFIG.PASSWORDS_KEY, JSON.stringify(passwords));
            
            showToast('Success', 'Viewer password changed successfully', 'success');
            document.getElementById('currentViewerPass').value = '';
            document.getElementById('newViewerPass').value = '';
        };

        window.showResetDataModal = function() {
            if (currentUserRole !== USER_ROLES.ADMIN) {
                showToast('Access Denied', 'Only admin can reset data', 'error');
                return;
            }
            
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-redo text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">Reset Data</h3>
                                <p class="opacity-90">Secure reset with backup & restore</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h4 class="font-bold text-red-800 mb-3 flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Warning: This Action Cannot Be Undone
                        </h4>
                        <p class="text-red-700">
                            Resetting data will delete all payments, withdrawals, and member financial data. 
                            Member information will be preserved but financial records will be cleared.
                        </p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Enter "RESET" to confirm</label>
                            <input type="text" id="resetConfirmation" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="Type RESET here">
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="backupBeforeReset" class="w-5 h-5" checked>
                            <label for="backupBeforeReset" class="text-sm text-gray-700">Create backup before resetting</label>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="keepMemberInfo" class="w-5 h-5" checked>
                            <label for="keepMemberInfo" class="text-sm text-gray-700">Keep member information (only clear financial data)</label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="createBackupBeforeReset()" class="bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Backup First
                        </button>
                        <button onclick="confirmResetData()" class="bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700">
                            <i class="fas fa-redo mr-2"></i>Reset Data
                        </button>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            `;
            
            showModal('Reset Data', html);
        };

        window.createBackupBeforeReset = function() {
            exportDataForEmail();
        };

        window.confirmResetData = function() {
            const confirmation = document.getElementById('resetConfirmation').value;
            const backupBefore = document.getElementById('backupBeforeReset').checked;
            const keepMemberInfo = document.getElementById('keepMemberInfo').checked;
            
            if (confirmation !== 'RESET') {
                showToast('Error', 'Please type "RESET" to confirm', 'error');
                return;
            }
            
            if (backupBefore) {
                exportDataForEmail();
            }
            
            // Reset data based on options
            if (keepMemberInfo) {
                // Clear only financial data
                payments = [];
                withdrawals = [];
                activities = [];
                receiptCounter = 1000;
                withdrawalReceiptCounter = 2000;
                
                // Reset member financial data
                employees.forEach((emp, index) => {
                    employees[index] = {
                        ...emp,
                        monthlyReceivable: CONFIG.MONTHLY_CONTRIBUTION,
                        totalReceived: 0,
                        currentMonthReceivable: CONFIG.MONTHLY_CONTRIBUTION,
                        lastUpdatedMonth: getCurrentMonthYear()
                    };
                });
                
                activities.push({
                    id: Date.now(),
                    user: currentUser,
                    action: 'Reset financial data (member information preserved)',
                    timestamp: new Date().toISOString()
                });
            } else {
                // Full reset to default data
                initializeDefaultData();
            }
            
            saveData();
            updateDashboard();
            closeModal();
            
            showToast('Success', 'Data reset completed successfully', 'success');
        };

        window.filterPayments = function() {
            const dateFrom = document.getElementById('paymentDateFrom').value;
            const dateTo = document.getElementById('paymentDateTo').value;
            const rows = document.querySelectorAll('#paymentsTableBody tr');
            
            rows.forEach(row => {
                const date = row.getAttribute('data-date');
                let show = true;
                
                if (dateFrom && date < dateFrom) {
                    show = false;
                }
                if (dateTo && date > dateTo) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        };

        window.filterWithdrawals = function() {
            const dateFrom = document.getElementById('withdrawalDateFrom').value;
            const dateTo = document.getElementById('withdrawalDateTo').value;
            const rows = document.querySelectorAll('#withdrawalsTableBody tr');
            
            rows.forEach(row => {
                const date = row.getAttribute('data-date');
                let show = true;
                
                if (dateFrom && date < dateFrom) {
                    show = false;
                }
                if (dateTo && date > dateTo) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        };

        window.showMessagingPanel = function() {
            let html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fab fa-whatsapp text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">WhatsApp Messaging</h3>
                                <p class="opacity-90">Send bulk messages/reminders to members</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-gray-200 rounded-xl p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Message Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Message Type</label>
                                    <select id="messageType" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                        <option value="payment-reminder">Payment Reminder</option>
                                        <option value="custom">Custom Message</option>
                                        <option value="announcement">Society Announcement</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Target Members</label>
                                    <select id="targetMembers" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                                        <option value="all">All Members</option>
                                        <option value="pending">Pending Payments Only</option>
                                        <option value="with-phone">Members With Phone Numbers</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border border-gray-200 rounded-xl p-6">
                            <h4 class="font-bold text-gray-800 mb-4">Message Preview</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p id="messagePreview" class="text-gray-700">
                                    Reminder: Monthly contribution of ₹${CONFIG.MONTHLY_CONTRIBUTION} is due. Please make the payment at your earliest convenience.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Custom Message</label>
                        <textarea id="customMessage" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" rows="4" placeholder="Type your custom message here..."></textarea>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-800 mb-2">Message Statistics</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Members:</span>
                                <span class="font-semibold" id="totalMessageMembers">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">With Phone Numbers:</span>
                                <span class="font-semibold" id="withPhoneMessage">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="previewMessages()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">
                            <i class="fas fa-eye mr-2"></i>Preview Messages
                        </button>
                        <button onclick="sendMessages()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700">
                            <i class="fab fa-whatsapp mr-2"></i>Send via WhatsApp
                        </button>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-gray-300 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            `;
            
            showModal('WhatsApp Messaging', html);
            
            // Update statistics
            const totalMembers = employees.filter(emp => !emp.deleted).length;
            const withPhone = employees.filter(emp => !emp.deleted && emp.phone && emp.phone.length >= 10).length;
            
            document.getElementById('totalMessageMembers').textContent = totalMembers;
            document.getElementById('withPhoneMessage').textContent = withPhone;
            
            // Update message preview when type changes
            document.getElementById('messageType').addEventListener('change', function() {
                updateMessagePreview();
            });
            
            document.getElementById('customMessage').addEventListener('input', function() {
                if (document.getElementById('messageType').value === 'custom') {
                    document.getElementById('messagePreview').textContent = this.value || 'Custom message will appear here';
                }
            });
        };

        window.updateMessagePreview = function() {
            const messageType = document.getElementById('messageType').value;
            let message = '';
            
            switch(messageType) {
                case 'payment-reminder':
                    message = `Reminder: Monthly contribution of ₹${CONFIG.MONTHLY_CONTRIBUTION} is due. Please make the payment at your earliest convenience.`;
                    break;
                case 'announcement':
                    message = `Society Announcement: Please attend the monthly meeting scheduled for this Friday at 3 PM in the conference room.`;
                    break;
                case 'custom':
                    const customMsg = document.getElementById('customMessage').value;
                    message = customMsg || 'Custom message will appear here';
                    break;
            }
            
            document.getElementById('messagePreview').textContent = message;
        };

        window.previewMessages = function() {
            const target = document.getElementById('targetMembers').value;
            let members = [];
            
            switch(target) {
                case 'all':
                    members = employees.filter(emp => !emp.deleted);
                    break;
                case 'pending':
                    members = employees.filter(emp => {
                        if (emp.deleted || emp.parked || emp.status === 'retired' || emp.transferred) return false;
                        const calculation = calculateMemberCurrentReceivable(emp);
                        return calculation.currentReceivable > 0;
                    });
                    break;
                case 'with-phone':
                    members = employees.filter(emp => !emp.deleted && emp.phone && emp.phone.length >= 10);
                    break;
            }
            
            let html = `
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-800">Message Preview for ${members.length} Members</h4>
                    ${members.slice(0, 5).map(member => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">${member.name}</span>
                                <span class="text-sm text-gray-600">${member.phone || 'No phone'}</span>
                            </div>
                            <p class="text-sm text-gray-700">${document.getElementById('messagePreview').textContent}</p>
                        </div>
                    `).join('')}
                    ${members.length > 5 ? `
                        <p class="text-center text-gray-600">... and ${members.length - 5} more members</p>
                    ` : ''}
                </div>
            `;
            
            showToast('Info', `Preview ready for ${members.length} members`, 'info');
        };

        window.sendMessages = function() {
            const messageType = document.getElementById('messageType').value;
            const target = document.getElementById('targetMembers').value;
            
            let members = [];
            let message = '';
            
            // Get message content
            if (messageType === 'custom') {
                message = document.getElementById('customMessage').value.trim();
            } else {
                message = document.getElementById('messagePreview').textContent;
            }
            
            if (!message) {
                showToast('Error', 'Please enter a message', 'error');
                return;
            }
            
            // Filter members based on target
            switch(target) {
                case 'all':
                    members = employees.filter(emp => !emp.deleted && emp.phone && emp.phone.length >= 10);
                    break;
                case 'pending':
                    members = employees.filter(emp => {
                        if (emp.deleted || emp.parked || emp.status === 'retired' || emp.transferred || !emp.phone || emp.phone.length < 10) return false;
                        const calculation = calculateMemberCurrentReceivable(emp);
                        return calculation.currentReceivable > 0;
                    });
                    break;
                case 'with-phone':
                    members = employees.filter(emp => !emp.deleted && emp.phone && emp.phone.length >= 10);
                    break;
            }
            
            if (members.length === 0) {
                showToast('Error', 'No members with valid phone numbers found', 'error');
                return;
            }
            
            // Open WhatsApp for each member (simplified - in reality you'd need a proper WhatsApp API)
            const member = members[0]; // For demo, just open for first member
            const whatsappUrl = `https://wa.me/91${member.phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('Success', `Opening WhatsApp for ${member.name}. For bulk messaging, you would need WhatsApp Business API.`, 'success');
        };

        window.sendReminder = function(memberId) {
            const member = employees.find(emp => emp.id === memberId);
            if (!member || !member.phone || member.phone.length < 10) {
                showToast('Error', 'Member does not have a valid phone number', 'error');
                return;
            }
            
            const calculation = calculateMemberCurrentReceivable(member);
            const message = `Payment Reminder for ${member.name}: Monthly contribution of ₹${CONFIG.MONTHLY_CONTRIBUTION} is due. Current pending amount: ₹${calculation.currentReceivable}. Please make the payment at your earliest convenience.`;
            
            const whatsappUrl = `https://wa.me/91${member.phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('Success', `Reminder sent to ${member.name}`, 'success');
        };

        window.sendRemindersToAll = function() {
            const pendingMembers = employees.filter(emp => {
                if (emp.deleted || emp.parked || emp.status === 'retired' || emp.transferred || !emp.phone || emp.phone.length < 10) return false;
                const calculation = calculateMemberCurrentReceivable(emp);
                return calculation.currentReceivable > 0;
            });
            
            if (pendingMembers.length === 0) {
                showToast('Info', 'No pending members with phone numbers found', 'info');
                return;
            }
            
            // For demo, just open for first member
            const member = pendingMembers[0];
            const calculation = calculateMemberCurrentReceivable(member);
            const message = `Payment Reminder for ${member.name}: Monthly contribution of ₹${CONFIG.MONTHLY_CONTRIBUTION} is due. Current pending amount: ₹${calculation.currentReceivable}. Please make the payment at your earliest convenience.`;
            
            const whatsappUrl = `https://wa.me/91${member.phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('Success', `Opened WhatsApp for ${member.name}. For bulk messaging, consider using WhatsApp Business API.`, 'success');
        };
    </script>
</body>
</html>
